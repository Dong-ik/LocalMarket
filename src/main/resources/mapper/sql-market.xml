<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.localmarket.mapper.MarketMapper">


    <!-- 복합 조건(검색+지역) + 찜 개수 포함 목록 조회 -->
    <select id="selectMarketsWithFavoriteBySearchAndLocal" resultMap="marketWithFavoriteResultMap">
        SELECT 
            m.market_id,
            m.market_name,
            m.market_local,
            m.market_address,
            m.market_introduce,
            m.market_filename,
            m.market_URL,
            m.created_date,
            IFNULL(v.favorite_count, 0) AS favorite_count
        FROM market m
        LEFT JOIN view_market_favorite_stats v ON m.market_id = v.market_id
        <where>
            <if test="search != null and search != ''">
                (m.market_name LIKE CONCAT('%', #{search}, '%') OR m.market_address LIKE CONCAT('%', #{search}, '%'))
            </if>
            <if test="local != null and local != ''">
                <choose>
                    <when test="local == '충북'">
                        AND (m.market_local LIKE '%충북%' OR m.market_local LIKE '%충청북도%')
                    </when>
                    <when test="local == '충남'">
                        AND (m.market_local LIKE '%충남%' OR m.market_local LIKE '%충청남도%')
                    </when>
                    <when test="local == '전북'">
                        AND (m.market_local LIKE '%전북%' OR m.market_local LIKE '%전라북도%')
                    </when>
                    <when test="local == '전남'">
                        AND (m.market_local LIKE '%전남%' OR m.market_local LIKE '%전라남도%')
                    </when>
                    <when test="local == '경북'">
                        AND (m.market_local LIKE '%경북%' OR m.market_local LIKE '%경상북도%')
                    </when>
                    <when test="local == '경남'">
                        AND (m.market_local LIKE '%경남%' OR m.market_local LIKE '%경상남도%')
                    </when>
                    <otherwise>
                        AND m.market_local LIKE CONCAT('%', #{local}, '%')
                    </otherwise>
                </choose>
            </if>
        </where>
        ORDER BY m.created_date DESC
    </select>

    <!-- 찜 개수 포함 ResultMap -->
    <resultMap id="marketWithFavoriteResultMap" type="com.localmarket.domain.Market">
        <id property="marketId" column="market_id"/>
        <result property="marketName" column="market_name"/>
        <result property="marketLocal" column="market_local"/>
        <result property="marketAddress" column="market_address"/>
        <result property="marketIntroduce" column="market_introduce"/>
        <result property="marketFilename" column="market_filename"/>
        <result property="marketURL" column="market_URL"/>
        <result property="createdDate" column="created_date"/>
        <result property="favoriteCount" column="favorite_count"/>
    </resultMap>

    <!-- 찜 개수 포함 전체 시장 목록 조회 (뷰 조인) -->
    <select id="selectAllMarketsWithFavorite" resultMap="marketWithFavoriteResultMap">
        SELECT 
            m.market_id,
            m.market_name,
            m.market_local,
            m.market_address,
            m.market_introduce,
            m.market_filename,
            m.market_URL,
            m.created_date,
            IFNULL(v.favorite_count, 0) AS favorite_count
        FROM market m
        LEFT JOIN view_market_favorite_stats v ON m.market_id = v.market_id
        ORDER BY m.created_date DESC
    </select>

    <!-- Result Map -->
    <resultMap id="marketResultMap" type="com.localmarket.domain.Market">
        <id property="marketId" column="market_id"/>
        <result property="marketName" column="market_name"/>
        <result property="marketLocal" column="market_local"/>
        <result property="marketAddress" column="market_address"/>
        <result property="marketIntroduce" column="market_introduce"/>
        <result property="marketFilename" column="market_filename"/>
        <result property="marketURL" column="market_URL"/>
        <result property="createdDate" column="created_date"/>
    </resultMap>

    <!-- 시장 등록 (API 데이터 삽입용) -->
    <insert id="insertMarket" parameterType="com.localmarket.domain.Market">
        INSERT INTO market (
            market_name,
            market_local,
            market_address,
            market_introduce,
            market_filename,
            market_URL,
            created_date
        ) VALUES (
            #{marketName},
            #{marketLocal},
            #{marketAddress},
            #{marketIntroduce},
            #{marketFilename},
            #{marketURL},
            #{createdDate}
        )
    </insert>

    <!-- 전체 시장 목록 조회 -->
    <select id="selectAllMarkets" resultMap="marketResultMap">
        SELECT 
            market_id,
            market_name,
            market_local,
            market_address,
            market_introduce,
            market_filename,
            market_URL,
            created_date
        FROM market
        ORDER BY created_date DESC
    </select>

    <!-- 지역별 시장 목록 조회 -->
    <select id="selectMarketsByLocal" parameterType="string" resultMap="marketResultMap">
        SELECT 
            market_id,
            market_name,
            market_local,
            market_address,
            market_introduce,
            market_filename,
            market_URL,
            created_date
        FROM market
        <choose>
            <when test="marketLocal == '충북'">
                WHERE (market_local LIKE '%충북%' OR market_local LIKE '%충청북도%')
            </when>
            <when test="marketLocal == '충남'">
                WHERE (market_local LIKE '%충남%' OR market_local LIKE '%충청남도%')
            </when>
            <when test="marketLocal == '전북'">
                WHERE (market_local LIKE '%전북%' OR market_local LIKE '%전라북도%')
            </when>
            <when test="marketLocal == '전남'">
                WHERE (market_local LIKE '%전남%' OR market_local LIKE '%전라남도%')
            </when>
            <when test="marketLocal == '경북'">
                WHERE (market_local LIKE '%경북%' OR market_local LIKE '%경상북도%')
            </when>
            <when test="marketLocal == '경남'">
                WHERE (market_local LIKE '%경남%' OR market_local LIKE '%경상남도%')
            </when>
            <otherwise>
                WHERE market_local LIKE CONCAT('%', #{marketLocal}, '%')
            </otherwise>
        </choose>
        ORDER BY created_date DESC
    </select>

    <!-- 시장 상세 조회 -->
    <select id="selectMarketById" parameterType="int" resultMap="marketResultMap">
        SELECT 
            market_id,
            market_name,
            market_local,
            market_address,
            market_introduce,
            market_filename,
            market_URL,
            created_date
        FROM market
        WHERE market_id = #{marketId}
    </select>

    <!-- 시장 이름으로 검색 -->
    <select id="selectMarketsByName" parameterType="string" resultMap="marketResultMap">
        SELECT 
            market_id,
            market_name,
            market_local,
            market_address,
            market_introduce,
            market_filename,
            market_URL,
            created_date
        FROM market
        WHERE market_name LIKE CONCAT('%', #{marketName}, '%')
        ORDER BY created_date DESC
    </select>

    <!-- 시장 주소로 검색 -->
    <select id="selectMarketsByAddress" parameterType="string" resultMap="marketResultMap">
        SELECT 
            market_id,
            market_name,
            market_local,
            market_address,
            market_introduce,
            market_filename,
            market_URL,
            created_date
        FROM market
        WHERE market_address LIKE CONCAT('%', #{marketAddress}, '%')
        ORDER BY created_date DESC
    </select>

    <!-- 최근 등록된 시장 목록 -->
    <select id="selectRecentMarkets" parameterType="int" resultMap="marketResultMap">
        SELECT 
            market_id,
            market_name,
            market_local,
            market_address,
            market_introduce,
            market_filename,
            market_URL,
            created_date
        FROM market
        ORDER BY created_date DESC
        LIMIT #{limit}
    </select>

    <!-- 시장 정보 수정 -->
    <update id="updateMarket" parameterType="com.localmarket.domain.Market">
        UPDATE market
        SET 
            market_name = #{marketName},
            market_local = #{marketLocal},
            market_address = #{marketAddress},
            market_introduce = #{marketIntroduce},
            market_filename = #{marketFilename},
            market_URL = #{marketURL}
        WHERE market_id = #{marketId}
    </update>

    <!-- 시장 삭제 -->
    <delete id="deleteMarket" parameterType="int">
        DELETE FROM market
        WHERE market_id = #{marketId}
    </delete>

    <!-- 시장 총 개수 조회 -->
    <select id="selectTotalMarketCount" resultType="int">
        SELECT COUNT(*)
        FROM market
    </select>

    <!-- 지역별 시장 개수 조회 -->
    <select id="selectMarketCountByLocal" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM market
        <choose>
            <when test="marketLocal == '충북'">
                WHERE (market_local LIKE '%충북%' OR market_local LIKE '%충청북도%')
            </when>
            <when test="marketLocal == '충남'">
                WHERE (market_local LIKE '%충남%' OR market_local LIKE '%충청남도%')
            </when>
            <when test="marketLocal == '전북'">
                WHERE (market_local LIKE '%전북%' OR market_local LIKE '%전라북도%')
            </when>
            <when test="marketLocal == '전남'">
                WHERE (market_local LIKE '%전남%' OR market_local LIKE '%전라남도%')
            </when>
            <when test="marketLocal == '경북'">
                WHERE (market_local LIKE '%경북%' OR market_local LIKE '%경상북도%')
            </when>
            <when test="marketLocal == '경남'">
                WHERE (market_local LIKE '%경남%' OR market_local LIKE '%경상남도%')
            </when>
            <otherwise>
                WHERE market_local LIKE CONCAT('%', #{marketLocal}, '%')
            </otherwise>
        </choose>
    </select>

    <!-- API 데이터 중복 체크 (같은 이름과 주소) -->
    <select id="selectMarketByNameAndAddress" resultMap="marketResultMap">
        SELECT 
            market_id,
            market_name,
            market_local,
            market_address,
            market_introduce,
            market_filename,
            market_URL,
            created_date
        FROM market
        WHERE market_name = #{marketName}
        AND market_address = #{marketAddress}
        LIMIT 1
    </select>

</mapper>