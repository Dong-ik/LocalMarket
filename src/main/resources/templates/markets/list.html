<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일반시장 목록 - LocalMarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
</head>
<body>
    <!-- 헤더 영역 -->
    <div th:replace="~{layout :: header}"></div>

    <!-- 메인 콘텐츠 -->
    <div class="container mt-4">
        <!-- 페이지 제목 및 검색 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h2 class="mb-0">
                    <i class="fas fa-store text-primary me-2"></i>
                    일반시장 목록
                </h2>
                <p class="text-muted mt-2">지역 상권과 다양한 상품을 만나보세요</p>
            </div>
            <div class="col-md-3">
                <form th:action="@{/markets/list}" method="get" class="d-flex">
                    <input type="text" class="form-control me-2" name="search" 
                           th:value="${searchTerm}" placeholder="시장명으로 검색">
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>
            <div class="col-md-3 text-end">
                <a href="/markets/import" class="btn btn-success">
                    <i class="fas fa-download me-2"></i>전통시장 데이터 가져오기
                </a>
            </div>
        </div>

        <!-- 필터 옵션 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-3">
                        <form th:action="@{/markets/list}" method="get" class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label for="location" class="form-label">지역 선택</label>
                                <select class="form-select" id="location" name="location">
                                    <option value="">전체 지역</option>
                                    <option value="서울" th:selected="${selectedLocation == '서울'}">서울</option>
                                    <option value="부산" th:selected="${selectedLocation == '부산'}">부산</option>
                                    <option value="대구" th:selected="${selectedLocation == '대구'}">대구</option>
                                    <option value="인천" th:selected="${selectedLocation == '인천'}">인천</option>
                                    <option value="광주" th:selected="${selectedLocation == '광주'}">광주</option>
                                    <option value="대전" th:selected="${selectedLocation == '대전'}">대전</option>
                                    <option value="울산" th:selected="${selectedLocation == '울산'}">울산</option>
                                    <option value="세종" th:selected="${selectedLocation == '세종'}">세종</option>
                                    <option value="경기" th:selected="${selectedLocation == '경기'}">경기</option>
                                    <option value="강원" th:selected="${selectedLocation == '강원'}">강원</option>
                                    <option value="충북" th:selected="${selectedLocation == '충북'}">충북</option>
                                    <option value="충남" th:selected="${selectedLocation == '충남'}">충남</option>
                                    <option value="전북" th:selected="${selectedLocation == '전북'}">전북</option>
                                    <option value="전남" th:selected="${selectedLocation == '전남'}">전남</option>
                                    <option value="경북" th:selected="${selectedLocation == '경북'}">경북</option>
                                    <option value="경남" th:selected="${selectedLocation == '경남'}">경남</option>
                                    <option value="제주" th:selected="${selectedLocation == '제주'}">제주</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="search" class="form-label">시장명 검색</label>
                                <input type="text" class="form-control" id="search" name="search" 
                                       th:value="${searchTerm}" placeholder="시장명을 입력하세요">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-filter me-2"></i>검색
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 검색 결과 정보 -->
        <div class="row mb-3" th:if="${searchTerm != null or selectedLocation != null}">
            <div class="col-12">
                <div class="alert alert-info border-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <span th:if="${searchTerm != null and selectedLocation != null}">
                        '<strong th:text="${searchTerm}"></strong>' 검색 결과 (<strong th:text="${selectedLocation}"></strong> 지역)
                    </span>
                    <span th:if="${searchTerm != null and selectedLocation == null}">
                        '<strong th:text="${searchTerm}"></strong>' 검색 결과
                    </span>
                    <span th:if="${searchTerm == null and selectedLocation != null}">
                        <strong th:text="${selectedLocation}"></strong> 지역 시장
                    </span>
                    - 총 <strong th:text="${#lists.size(markets)}"></strong>개 시장
                </div>
            </div>
        </div>

        <!-- 시장 목록 -->
        <div class="row" th:if="${markets != null and !markets.isEmpty()}">
            <div class="col-lg-4 col-md-6 mb-4" th:each="market : ${markets}">
                <div class="card h-100 shadow-sm border-0 market-card">
                    <!-- 시장 이미지 -->
                    <div class="position-relative">
                        <img th:if="${market.marketFilename != null and !market.marketFilename.isEmpty()}" 
                             th:src="@{'/images/markets/' + ${market.marketFilename}}" 
                             class="card-img-top market-image" 
                             th:alt="${market.marketName}"
                             style="height: 200px; object-fit: cover;">
                        <img th:if="${market.marketFilename == null or market.marketFilename.isEmpty()}" 
                             src="/images/default-market.jpg" 
                             class="card-img-top market-image" 
                             th:alt="${market.marketName}"
                             style="height: 200px; object-fit: cover;">
                        <!-- 지역 뱃지 -->
                        <span class="badge bg-primary position-absolute top-0 end-0 m-2" 
                              th:text="${market.marketLocal}"></span>
                    </div>
                    
                    <div class="card-body">
                        <h5 class="card-title text-truncate" th:text="${market.marketName}"></h5>
                        <p class="card-text text-muted small">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            <span th:text="${market.marketAddress ?: '주소 정보 없음'}"></span>
                        </p>
                        <p class="card-text" th:if="${market.marketIntroduce != null and !market.marketIntroduce.isEmpty()}">
                            <span th:text="${#strings.length(market.marketIntroduce) > 100 ? 
                                          #strings.substring(market.marketIntroduce, 0, 100) + '...' : 
                                          market.marketIntroduce}"></span>
                        </p>
                    </div>
                    
                    <div class="card-footer bg-transparent border-top-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-store me-1"></i>
                                <span class="store-count" th:data-market-id="${market.marketId}">
                                    가게 수 로딩 중...
                                </span>
                            </small>
                            <div class="btn-group" role="group">
                                <a th:href="@{/markets/detail/{id}(id=${market.marketId})}" 
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>상세보기
                                </a>
                                <a th:if="${market.marketUrl != null and !market.marketUrl.isEmpty()}"
                                   th:href="${market.marketUrl}" 
                                   target="_blank"
                                   class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-external-link-alt me-1"></i>홈페이지
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 검색 결과 없음 -->
        <div class="row" th:if="${markets == null or markets.isEmpty()}">
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">검색 결과가 없습니다</h4>
                    <p class="text-muted">다른 검색어로 다시 시도해보세요.</p>
                    <a href="/markets/list" class="btn btn-primary">
                        <i class="fas fa-list me-2"></i>전체 시장 보기
                    </a>
                </div>
            </div>
        </div>

        <!-- 페이지네이션 (필요시 추가) -->
        <div class="row mt-5" th:if="${markets != null and markets.size() > 12}">
            <div class="col-12">
                <nav aria-label="시장 목록 페이지네이션">
                    <ul class="pagination justify-content-center">
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="이전">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="다음">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 푸터 영역 -->
    <div th:replace="~{layout :: footer}"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 각 시장의 가게 수를 AJAX로 로딩
        document.addEventListener('DOMContentLoaded', function() {
            const storeCountElements = document.querySelectorAll('.store-count');
            
            storeCountElements.forEach(function(element) {
                const marketId = element.getAttribute('data-market-id');
                
                fetch(`/api/markets/${marketId}/stores/count`)
                    .then(response => response.json())
                    .then(count => {
                        element.textContent = `가게 ${count}개`;
                    })
                    .catch(error => {
                        console.error('가게 수 로딩 실패:', error);
                        element.textContent = '가게 수 조회 실패';
                    });
            });
        });
        
        // 카드 호버 효과
        document.querySelectorAll('.market-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.transition = 'transform 0.3s ease';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    </script>

    <style>
        .market-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .market-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
        }
        
        .market-image {
            transition: transform 0.3s ease;
        }
        
        .market-card:hover .market-image {
            transform: scale(1.05);
        }
        
        .card-footer .btn-group .btn {
            border-radius: 0.375rem;
        }
    </style>
</body>
</html>