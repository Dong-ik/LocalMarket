<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<!-- 헤더 Include -->
<div th:replace="~{common/header}"></div>

<link rel="stylesheet" th:href="@{/css/member.css}">

<div class="container" style="margin-top: 100px; margin-bottom: 60px;">
    <div class="page-header">
        <h1><i class="fas fa-store"></i> 시장 관리</h1>
        <p class="subtitle">전체 시장 목록을 조회하고 관리할 수 있습니다</p>
    </div>
    
    <!-- 검색 영역 -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" id="searchKeyword" placeholder="시장명, 지역, 주소로 검색하세요..." />
            <button onclick="searchMarkets()" class="btn-search">
                <i class="fas fa-search"></i> 검색
            </button>
        </div>
        <div class="member-count">
            <i class="fas fa-shopping-bag"></i>
            전체 시장: <strong th:text="${totalCount}"></strong>개
        </div>
        <button onclick="importMarketsFromAPI()" class="btn-import" title="공공데이터 API에서 시장 정보 가져오기">
            <i class="fas fa-cloud-download-alt"></i> 공공데이터 가져오기
        </button>
    </div>

    <!-- 파일 업로드 영역 -->
    <div class="file-upload-section">
        <div class="upload-container">
            <div class="upload-item">
                <label for="csvFile" class="upload-label">
                    <i class="fas fa-file-csv"></i>
                    <span>CSV 파일 업로드</span>
                </label>
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                <button onclick="uploadCSVFile()" class="btn-file-upload csv" title="CSV 파일에서 시장 정보 가져오기">
                    <i class="fas fa-upload"></i> CSV 업로드
                </button>
                <span class="file-info" id="csvFileInfo"></span>
            </div>

            <div class="upload-item">
                <label for="jsonFile" class="upload-label">
                    <i class="fas fa-file-code"></i>
                    <span>JSON 파일 업로드</span>
                </label>
                <input type="file" id="jsonFile" accept=".json" style="display: none;">
                <button onclick="uploadJSONFile()" class="btn-file-upload json" title="JSON 파일에서 시장 정보 가져오기">
                    <i class="fas fa-upload"></i> JSON 업로드
                </button>
                <span class="file-info" id="jsonFileInfo"></span>
            </div>
        </div>
    </div>

    <!-- 지역별 필터 버튼 -->
    <div class="filter-section">
        <button class="filter-btn active" onclick="filterByLocation('ALL')">
            <i class="fas fa-globe"></i> 전체
        </button>
        <button class="filter-btn" onclick="filterByLocation('서울')">
            <i class="fas fa-map-marker-alt"></i> 서울
        </button>
        <button class="filter-btn" onclick="filterByLocation('부산')">
            <i class="fas fa-map-marker-alt"></i> 부산
        </button>
        <button class="filter-btn" onclick="filterByLocation('대구')">
            <i class="fas fa-map-marker-alt"></i> 대구
        </button>
        <button class="filter-btn" onclick="filterByLocation('인천')">
            <i class="fas fa-map-marker-alt"></i> 인천
        </button>
        <button class="filter-btn" onclick="filterByLocation('광주')">
            <i class="fas fa-map-marker-alt"></i> 광주
        </button>
        <button class="filter-btn" onclick="filterByLocation('대전')">
            <i class="fas fa-map-marker-alt"></i> 대전
        </button>
        <button class="filter-btn" onclick="filterByLocation('울산')">
            <i class="fas fa-map-marker-alt"></i> 울산
        </button>
        <button class="filter-btn" onclick="filterByLocation('세종')">
            <i class="fas fa-map-marker-alt"></i> 세종
        </button>
        <button class="filter-btn" onclick="filterByLocation('경기')">
            <i class="fas fa-map-marker-alt"></i> 경기
        </button>
        <button class="filter-btn" onclick="filterByLocation('강원')">
            <i class="fas fa-map-marker-alt"></i> 강원
        </button>
        <button class="filter-btn" onclick="filterByLocation('충북')">
            <i class="fas fa-map-marker-alt"></i> 충북
        </button>
        <button class="filter-btn" onclick="filterByLocation('충남')">
            <i class="fas fa-map-marker-alt"></i> 충남
        </button>
        <button class="filter-btn" onclick="filterByLocation('전북')">
            <i class="fas fa-map-marker-alt"></i> 전북
        </button>
        <button class="filter-btn" onclick="filterByLocation('전남')">
            <i class="fas fa-map-marker-alt"></i> 전남
        </button>
        <button class="filter-btn" onclick="filterByLocation('경북')">
            <i class="fas fa-map-marker-alt"></i> 경북
        </button>
        <button class="filter-btn" onclick="filterByLocation('경남')">
            <i class="fas fa-map-marker-alt"></i> 경남
        </button>
        <button class="filter-btn" onclick="filterByLocation('제주')">
            <i class="fas fa-map-marker-alt"></i> 제주
        </button>
    </div>
    
    <!-- 시장 목록 테이블 -->
    <div class="member-list-container">
        <table class="member-table">
        <thead>
            <tr>
                <th>번호</th>
                <th>시장명</th>
                <th>지역</th>
                <th>주소</th>
                <th>등록일</th>
                <th>찜수</th>
                <th>관리</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="market, stat : ${markets}" th:id="'market-row-' + ${market.marketId}">
                <td th:text="${stat.count}"></td>
                <td>
                    <strong th:text="${market.marketName}"></strong>
                </td>
                <td th:text="${market.marketLocal}"></td>
                <td>
                    <span class="address" th:text="${market.marketAddress}"></span>
                </td>
                <td th:text="${#temporals.format(market.createdDate, 'yyyy-MM-dd')}"></td>
                <td th:text="${market.favoriteCount != null ? market.favoriteCount : 0}"></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-edit" 
                                th:data-market-id="${market.marketId}"
                                onclick="editMarket(this.dataset.marketId)">
                            <i class="fas fa-edit"></i> 수정
                        </button>
                        <button class="btn-delete" 
                                th:data-market-id="${market.marketId}"
                                th:data-market-name="${market.marketName}"
                                onclick="deleteMarket(this.dataset.marketId, this.dataset.marketName)">
                            <i class="fas fa-trash"></i> 삭제
                        </button>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    
    <!-- 데이터 없을 때 -->
    <div th:if="${markets.isEmpty()}" class="no-data">
        <i class="fas fa-store-slash"></i>
        <p>등록된 시장이 없습니다.</p>
    </div>
    </div>
</div>

<div th:replace="~{common/footer}"></div>

<script>
// 현재 선택된 지역 필터
let currentLocationFilter = 'ALL';

// 시장 검색
function searchMarkets() {
    const keyword = document.getElementById('searchKeyword').value.toLowerCase();
    const rows = document.querySelectorAll('.member-table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const locationCell = row.cells[2]; // 지역 컬럼 (3번째)
        const location = locationCell ? locationCell.textContent.trim() : '';
        
        // 키워드 매치
        const keywordMatch = text.includes(keyword);
        
        // 지역 필터 매치
        let locationMatch = true;
        if (currentLocationFilter !== 'ALL') {
            locationMatch = location.includes(currentLocationFilter);
        }
        
        // 둘 다 매치되어야 표시
        if (keywordMatch && locationMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    updateTotalCount();
}

// 지역별 필터
function filterByLocation(location) {
    currentLocationFilter = location;
    
    // 버튼 활성화 상태 변경
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.closest('.filter-btn').classList.add('active');
    
    // 검색 실행
    searchMarkets();
}

// 엔터키로 검색
document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchMarkets();
    }
});

// 실시간 검색
document.getElementById('searchKeyword').addEventListener('input', function() {
    searchMarkets();
});

// 시장 수정
function editMarket(marketId) {
    window.location.href = `/markets/${marketId}/edit`;
}

// 시장 삭제
function deleteMarket(marketId, marketName) {
    if (!confirm(`'${marketName}' 시장을 정말 삭제하시겠습니까?\n\n삭제된 시장 정보는 복구할 수 없습니다.`)) {
        return;
    }
    
    fetch(`/api/market/${marketId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // 해당 행 제거
            const row = document.getElementById(`market-row-${marketId}`);
            if (row) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => {
                    row.remove();
                    // 전체 카운트 업데이트
                    updateTotalCount();
                }, 300);
            }
        } else {
            alert(data.message || '시장 삭제에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('시장 삭제 중 오류가 발생했습니다.');
    });
}

// 시장 수 업데이트
function updateTotalCount() {
    const visibleRows = document.querySelectorAll('.member-table tbody tr:not([style*="display: none"])');
    const countElement = document.querySelector('.member-count strong');
    if (countElement) {
        countElement.textContent = visibleRows.length;
    }
}

// 공공데이터 API에서 시장 정보 가져오기
function importMarketsFromAPI() {
    const button = event.target.closest('.btn-import');
    const originalText = button.innerHTML;

    if (!confirm('공공데이터 API에서 시장 정보를 가져오시겠습니까?\n\n처리 중에는 페이지가 잠시 비활성화됩니다.')) {
        return;
    }

    // 버튼 비활성화 및 로딩 상태 표시
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 데이터 가져오는 중...';

    fetch('/api/market/import-from-api', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            page: 1,
            perPage: 100
        })
    })
    .then(response => response.json())
    .then(data => {
        button.disabled = false;
        button.innerHTML = originalText;

        if (data.success) {
            alert(`공공데이터 API에서 시장 정보를 가져왔습니다.\n\n추가된 시장: ${data.addedCount || 0}개\n중복된 시장: ${data.duplicateCount || 0}개`);
            // 페이지 새로고침
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            alert(`데이터 가져오기 실패\n\n${data.message || '알 수 없는 오류가 발생했습니다.'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.disabled = false;
        button.innerHTML = originalText;
        alert('데이터 가져오기 중 오류가 발생했습니다.\n' + error.message);
    });
}

// CSV 파일 선택 클릭
function uploadCSVFile() {
    document.getElementById('csvFile').click();
}

// CSV 파일 업로드
document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.name.endsWith('.csv')) {
        alert('CSV 파일만 선택 가능합니다.');
        return;
    }

    if (!confirm(`'${file.name}' 파일로부터 시장 정보를 가져오시겠습니까?`)) {
        e.target.value = '';
        return;
    }

    uploadFileToServer(file, 'csv');
});

// JSON 파일 선택 클릭
function uploadJSONFile() {
    document.getElementById('jsonFile').click();
}

// JSON 파일 업로드
document.getElementById('jsonFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.name.endsWith('.json')) {
        alert('JSON 파일만 선택 가능합니다.');
        return;
    }

    if (!confirm(`'${file.name}' 파일로부터 시장 정보를 가져오시겠습니까?`)) {
        e.target.value = '';
        return;
    }

    uploadFileToServer(file, 'json');
});

// 파일 서버에 업로드
function uploadFileToServer(file, fileType) {
    const formData = new FormData();
    formData.append('file', file);

    const endpoint = fileType === 'csv' ? '/api/market/import-from-csv' : '/api/market/import-from-json';
    const fileInput = fileType === 'csv' ? document.getElementById('csvFile') : document.getElementById('jsonFile');
    const fileInfo = fileType === 'csv' ? document.getElementById('csvFileInfo') : document.getElementById('jsonFileInfo');
    const fileInputId = fileType === 'csv' ? 'csvFile' : 'jsonFile';

    // 로딩 상태 표시
    fileInfo.textContent = '업로드 중...';

    fetch(endpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        fileInput.value = '';

        if (data.success) {
            fileInfo.innerHTML = `<div style="color: #10b981; font-weight: 600;">✓ 업로드 완료</div>
                <div style="color: #059669; font-size: 0.9rem; margin-top: 4px;">
                    추가: ${data.addedCount || 0}개 | 중복: ${data.duplicateCount || 0}개
                </div>`;

            // 1초 후 페이지 새로고침
            setTimeout(() => {
                window.location.href = window.location.href;
            }, 1000);
        } else {
            const errorMsg = data.message || '알 수 없는 오류가 발생했습니다.';
            fileInfo.innerHTML = `<div style="color: #ef4444; font-weight: 600;">✗ 업로드 실패</div>
                <div style="color: #dc2626; font-size: 0.9rem; margin-top: 4px;">${errorMsg}</div>`;
        }

        // 4초 후 상태 메시지 제거
        setTimeout(() => {
            fileInfo.textContent = '';
        }, 4000);
    })
    .catch(error => {
        console.error('Error:', error);
        fileInput.value = '';
        fileInfo.textContent = '✗ 업로드 중 오류 발생';
        fileInfo.style.color = '#ef4444';
        alert(`${fileType.toUpperCase()} 파일 업로드 중 오류가 발생했습니다.\n` + error.message);

        setTimeout(() => {
            fileInfo.textContent = '';
            fileInfo.style.color = '';
        }, 2000);
    });
}
</script>

</html>
