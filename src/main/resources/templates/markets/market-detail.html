<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${market != null ? market.marketName + ' - ÏãúÏû• ÏÉÅÏÑ∏' : 'ÏãúÏû• ÏÉÅÏÑ∏'}">ÏãúÏû• ÏÉÅÏÑ∏</title>
    <!-- CSS Ïó∞Í≤∞ -->
    <link rel="stylesheet" th:href="@{/css/market-detail.css}">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Ïπ¥Ïπ¥Ïò§Îßµ API Ïä§ÌÅ¨Î¶ΩÌä∏Î•º body ÏãúÏûë Î∂ÄÎ∂ÑÏóê Î°úÎìú -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        var kakaoMapApiKey = /*[[${kakaoMapApiKey}]]*/ '';
        console.log('üîë API ÌÇ§:', kakaoMapApiKey);
        
        if (kakaoMapApiKey && kakaoMapApiKey !== 'YOUR_API_KEY_HERE') {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + kakaoMapApiKey + '&libraries=services&autoload=false';
            script.onload = function() {
                console.log('‚úÖ Ïπ¥Ïπ¥Ïò§Îßµ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú ÏôÑÎ£å');
                kakao.maps.load(function() {
                    console.log('‚úÖ Ïπ¥Ïπ¥Ïò§Îßµ API Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                });
            };
            script.onerror = function() {
                console.error('‚ùå Ïπ¥Ïπ¥Ïò§Îßµ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú Ïã§Ìå®');
            };
            document.head.appendChild(script);
        } else {
            console.error('‚ùå API ÌÇ§Í∞Ä ÏóÜÏäµÎãàÎã§:', kakaoMapApiKey);
        }
        /*]]>*/
    </script>
    
    <!-- Ìó§Îçî Include -->
    <div th:replace="~{common/header}"></div>

    <!-- ÏãúÏû• ÏÉÅÏÑ∏ Ïª®ÌÖêÏ∏† -->
    <div class="market-detail-container" th:if="${market != null}">
        <!-- ÏãúÏû• Ìó§Îçî ÏòÅÏó≠ -->
        <section class="market-header">
            <div class="container">
                <div class="breadcrumb">
                    <a th:href="@{/}">Ìôà</a>
                    <i class="fas fa-chevron-right"></i>
                    <a th:href="@{/markets}">Ï†ÑÌÜµÏãúÏû•</a>
                    <i class="fas fa-chevron-right"></i>
                    <span th:text="${market.marketName}">ÏãúÏû•Î™Ö</span>
                </div>
                
                <div class="market-title-section">
                    <div class="market-title-left">
                        <h1 class="market-name" th:text="${market.marketName}">ÏãúÏû•Î™Ö</h1>
                        <div class="market-meta">
                            <span class="location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span th:text="${market.marketLocal}">ÏßÄÏó≠</span>
                            </span>
                            <span class="favorites" th:if="${market.favoriteCount != null && market.favoriteCount > 0}">
                                <i class="fas fa-heart"></i>
                                <span th:text="${market.favoriteCount}">0</span>Î™ÖÏù¥ Ï∞úÌñàÏñ¥Ïöî
                            </span>
                        </div>
                    </div>
                    
                    <div class="market-title-right">
                        <button class="favorite-btn" onclick="toggleFavorite()">
                            <i class="far fa-heart"></i>
                            <span>Ï∞úÌïòÍ∏∞</span>
                        </button>
                        <button class="share-btn" onclick="shareMarket()" 
                                th:data-market-name="${market.marketName}">
                            <i class="fas fa-share-alt"></i>
                            <span>Í≥µÏú†ÌïòÍ∏∞</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ÏãúÏû• ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏòÅÏó≠ -->
        <section class="market-content">
            <div class="container">
                <div class="content-grid">
                    <!-- ÏôºÏ™Ω: ÏãúÏû• Ïù¥ÎØ∏ÏßÄ Î∞è Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
                    <div class="content-left">
                        <!-- ÏãúÏû• ÎåÄÌëú Ïù¥ÎØ∏ÏßÄ -->
                        <div class="market-image-section">
                            <div class="main-image">
                                <img th:src="${market.marketURL != null && !market.marketURL.isEmpty() 
                                    ? market.marketURL 
                                    : '/images/default-market.jpg'}" 
                                     th:alt="${market.marketName}"
                                     onerror="this.src='/images/default-market.jpg'">
                            </div>
                        </div>

                        <!-- ÏãúÏû• ÏÜåÍ∞ú -->
                        <div class="market-description-section">
                            <h2 class="section-title">
                                <i class="fas fa-store"></i>
                                ÏãúÏû• ÏÜåÍ∞ú
                            </h2>
                            <div class="description-content" th:if="${market.marketIntroduce != null && !market.marketIntroduce.isEmpty()}">
                                <p th:text="${market.marketIntroduce}">ÏãúÏû• ÏÜåÍ∞ú ÎÇ¥Ïö©</p>
                            </div>
                            <div class="description-content" th:if="${market.marketIntroduce == null || market.marketIntroduce.isEmpty()}">
                                <p class="no-info">ÏãúÏû• ÏÜåÍ∞ú Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                            </div>
                        </div>

                        <!-- Ï∞æÏïÑÍ∞ÄÎäî Í∏∏ -->
                        <div class="market-location-section">
                            <h2 class="section-title">
                                <i class="fas fa-map-marked-alt"></i>
                                Ï∞æÏïÑÍ∞ÄÎäî Í∏∏
                            </h2>
                            <div class="location-info">
                                <div class="info-row" th:if="${market.marketAddress != null && !market.marketAddress.isEmpty()}">
                                    <span class="info-label">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Ï£ºÏÜå
                                    </span>
                                    <span class="info-value" th:text="${market.marketAddress}">Ï£ºÏÜå</span>
                                </div>
                                
                                <div class="info-row" th:if="${market.marketLocal != null && !market.marketLocal.isEmpty()}">
                                    <span class="info-label">
                                        <i class="fas fa-map-pin"></i>
                                        ÏßÄÏó≠
                                    </span>
                                    <span class="info-value" th:text="${market.marketLocal}">ÏßÄÏó≠</span>
                                </div>
                            </div>

                            <!-- ÏßÄÎèÑ ÏòÅÏó≠ -->
                            <div class="map-container" th:if="${market.marketAddress != null && !market.marketAddress.isEmpty()}">
                                <div id="map" 
                                     th:data-address="${market.marketAddress}"
                                     th:data-name="${market.marketName}"
                                     style="width:100%;height:300px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Ïò§Î•∏Ï™Ω: ÌÜµÍ≥Ñ Î∞è Î∂ÄÍ∞Ä Ï†ïÎ≥¥ -->
                    <div class="content-right">
                        <!-- ÏãúÏû• ÌÜµÍ≥Ñ Ïπ¥Îìú -->
                        <div class="stats-card">
                            <h3 class="card-title">ÏãúÏû• Ï†ïÎ≥¥</h3>
                            <div class="stats-grid">
                                <div class="stat-item" th:if="${market.favoriteCount != null}">
                                    <div class="stat-icon favorite">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-label">Ï∞úÌïòÍ∏∞</div>
                                        <div class="stat-value">
                                            <span th:text="${market.favoriteCount}">0</span>Î™Ö
                                        </div>
                                    </div>
                                </div>

                                <div class="stat-item" th:if="${market.marketLocal != null}">
                                    <div class="stat-icon location">
                                        <i class="fas fa-map-pin"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-label">ÏßÄÏó≠</div>
                                        <div class="stat-value" th:text="${market.marketLocal}">ÏßÄÏó≠</div>
                                    </div>
                                </div>
                                
                                <div class="stat-item">
                                    <div class="stat-icon">
                                        <i class="fas fa-calendar"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-label">Îì±Î°ùÏùº</div>
                                        <div class="stat-value" th:text="${#temporals.format(market.createdDate, 'yyyy-MM-dd')}">ÎÇ†Ïßú</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÏãúÏû• ÌååÏùº Ï†ïÎ≥¥ -->
                        <div class="features-card" th:if="${market.marketFilename != null && !market.marketFilename.isEmpty()}">
                            <h3 class="card-title">Ï∂îÍ∞Ä Ï†ïÎ≥¥</h3>
                            <div class="features-list">
                                <div class="feature-item">
                                    <i class="fas fa-file"></i>
                                    <span class="feature-label">Í¥ÄÎ†® ÌååÏùº:</span>
                                    <span class="feature-value" th:text="${market.marketFilename}">ÌååÏùºÎ™Ö</span>
                                </div>
                            </div>
                        </div>

                        <!-- Ïï°ÏÖò Î≤ÑÌäº -->
                        <div class="action-buttons">
                            <a th:href="@{/stores(marketId=${market.marketId})}" class="action-btn primary">
                                <i class="fas fa-store"></i>
                                <span>Ïù¥ ÏãúÏû•Ïùò Ï†êÌè¨ Î≥¥Í∏∞</span>
                            </a>
                            <a th:href="@{/markets}" class="action-btn outline">
                                <i class="fas fa-list"></i>
                                <span>ÏãúÏû• Î™©Î°ùÏúºÎ°ú</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- ÏãúÏû• Ï†ïÎ≥¥Í∞Ä ÏóÜÏùÑ Îïå -->
    <div class="no-market-container" th:if="${market == null}">
        <div class="container">
            <div class="no-market-content">
                <i class="fas fa-exclamation-circle"></i>
                <h2>ÏãúÏû•ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</h2>
                <p>ÏöîÏ≤≠ÌïòÏã† ÏãúÏû• Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                <a th:href="@{/markets}" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    ÏãúÏû• Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
                </a>
            </div>
        </div>
    </div>

    <!-- Ìë∏ÌÑ∞ Include -->
    <div th:replace="~{common/footer}"></div>

    <!-- JavaScript -->
    <script>
        // Ï∞úÌïòÍ∏∞ ÌÜ†Í∏Ä
        function toggleFavorite() {
            // TODO: Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨ Î∞è Ï∞úÌïòÍ∏∞ API Ìò∏Ï∂ú
            alert('Ï∞úÌïòÍ∏∞ Í∏∞Îä•ÏùÄ Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.');
        }

        // Í≥µÏú†ÌïòÍ∏∞
        function shareMarket() {
            var shareBtn = document.querySelector('.share-btn');
            var marketName = shareBtn ? shareBtn.getAttribute('data-market-name') : '';
            var currentUrl = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: marketName,
                    url: currentUrl
                }).then(function() {
                    console.log('Í≥µÏú† ÏÑ±Í≥µ');
                }).catch(function(error) {
                    console.log('Í≥µÏú† Ïã§Ìå®:', error);
                    copyToClipboard(currentUrl);
                });
            } else {
                copyToClipboard(currentUrl);
            }
        }

        // ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('ÎßÅÌÅ¨Í∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
            }).catch(function(err) {
                console.error('Î≥µÏÇ¨ Ïã§Ìå®:', err);
            });
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïã§Ìñâ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM Î°úÎìú ÏôÑÎ£å');
            console.log('üîë API ÌÇ§:', kakaoMapApiKey);
            
            // Ïπ¥Ïπ¥Ïò§Îßµ Ïä§ÌÅ¨Î¶ΩÌä∏ ÎèôÏ†Å Î°úÎìú
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' + kakaoMapApiKey + '&libraries=services&autoload=false';
            
            script.onload = function() {
                console.log('‚úÖ Ïπ¥Ïπ¥Ïò§Îßµ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú ÏôÑÎ£å');
                
                // Ïπ¥Ïπ¥Ïò§Îßµ API Ï¥àÍ∏∞Ìôî
                kakao.maps.load(function() {
                    console.log('‚úÖ Ïπ¥Ïπ¥Ïò§Îßµ API Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
                    
                    // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
                    initKakaoMap();
                });
            };
            
            script.onerror = function() {
                console.error('‚ùå Ïπ¥Ïπ¥Ïò§Îßµ Ïä§ÌÅ¨Î¶ΩÌä∏ Î°úÎìú Ïã§Ìå®');
                showMapError('Ïπ¥Ïπ¥Ïò§Îßµ APIÎ•º Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.<br>ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞Í≥º API ÌÇ§Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
            };
            
            document.head.appendChild(script);
            console.log('üì° Ïπ¥Ïπ¥Ïò§Îßµ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏöîÏ≤≠:', script.src);
        });
        
        // Ïπ¥Ïπ¥Ïò§Îßµ Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        function initKakaoMap() {
            console.log('üó∫Ô∏è initKakaoMap Ìï®Ïàò ÏãúÏûë');
            
            var mapContainer = document.getElementById('map');
            
            if (!mapContainer) {
                console.error('‚ùå ÏßÄÎèÑ Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            console.log('‚úÖ ÏßÄÎèÑ Ïª®ÌÖåÏù¥ÎÑà Î∞úÍ≤¨:', mapContainer);
            
            // data ÏÜçÏÑ±ÏóêÏÑú Ï£ºÏÜåÏôÄ Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
            var marketAddress = mapContainer.getAttribute('data-address');
            var marketName = mapContainer.getAttribute('data-name');
            
            console.log('üìç ÏãúÏû• Ï£ºÏÜå:', marketAddress);
            console.log('üè™ ÏãúÏû• Ïù¥Î¶Ñ:', marketName);
            
            if (!marketAddress) {
                console.error('‚ùå Ï£ºÏÜå Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.');
                showMapError('Ï£ºÏÜå Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§');
                return;
            }
            
            // ÏßÄÎèÑ ÏòµÏÖò ÏÑ§Ï†ï
            var options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // Í∏∞Î≥∏ Ï§ëÏã¨Ï¢åÌëú (ÏÑúÏö∏ÏãúÏ≤≠)
                level: 3 // ÏßÄÎèÑ ÌôïÎåÄ Î†àÎ≤®
            };
            
            console.log('üó∫Ô∏è ÏßÄÎèÑ ÏÉùÏÑ± ÏãúÏûë...');
            
            try {
                // ÏßÄÎèÑ ÏÉùÏÑ±
                var map = new kakao.maps.Map(mapContainer, options);
                
                console.log('‚úÖ ÏßÄÎèÑ ÏÉùÏÑ± ÏôÑÎ£å');
                
                // Ï£ºÏÜå-Ï¢åÌëú Î≥ÄÌôò Í∞ùÏ≤¥ ÏÉùÏÑ±
                var geocoder = new kakao.maps.services.Geocoder();
                
                console.log('üîç Ï£ºÏÜå Í≤ÄÏÉâ ÏãúÏûë:', marketAddress);
                
                // Ï£ºÏÜåÎ°ú Ï¢åÌëúÎ•º Í≤ÄÏÉâ
                geocoder.addressSearch(marketAddress, function(result, status) {
                    console.log('üìç Ï£ºÏÜå Í≤ÄÏÉâ Í≤∞Í≥º ÏÉÅÌÉú:', status);
                    
                    if (status === kakao.maps.services.Status.OK) {
                        console.log('‚úÖ Ï£ºÏÜå Í≤ÄÏÉâ ÏÑ±Í≥µ:', result[0]);
                        
                        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                        
                        // Í≤∞Í≥ºÍ∞íÏúºÎ°ú Î∞õÏùÄ ÏúÑÏπòÎ•º ÏßÄÎèÑ Ï§ëÏã¨ÏúºÎ°ú Ïù¥Îèô
                        map.setCenter(coords);
                        
                        // ÎßàÏª§ ÏÉùÏÑ±
                        var marker = new kakao.maps.Marker({
                            map: map,
                            position: coords
                        });
                        
                        // Ïù∏Ìè¨ÏúàÎèÑÏö∞Î°ú Ïû•ÏÜåÏóê ÎåÄÌïú ÏÑ§Î™Ö ÌëúÏãú
                        var infowindow = new kakao.maps.InfoWindow({
                            content: '<div style="width:150px;text-align:center;padding:6px 0;font-size:12px;font-weight:bold;">' + marketName + '</div>'
                        });
                        infowindow.open(map, marker);
                        
                        console.log('‚úÖ ÎßàÏª§ Î∞è Ï†ïÎ≥¥Ï∞Ω ÌëúÏãú ÏôÑÎ£å');
                        
                        // ÎßàÏª§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ - Ïπ¥Ïπ¥Ïò§ÎßµÏúºÎ°ú Í∏∏Ï∞æÍ∏∞
                        kakao.maps.event.addListener(marker, 'click', function() {
                            var kakaoMapUrl = 'https://map.kakao.com/link/map/' + marketName + ',' + result[0].y + ',' + result[0].x;
                            window.open(kakaoMapUrl, '_blank');
                        });
                        
                        console.log('‚úÖ ÏßÄÎèÑ Î°úÎìú ÏôÑÎ£å:', marketName);
                    } else {
                        console.error('‚ùå Ï£ºÏÜå Í≤ÄÏÉâ Ïã§Ìå®:', status, 'Ï£ºÏÜå:', marketAddress);
                        showMapError('Ï£ºÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§<br>' + marketAddress);
                    }
                });
            } catch (error) {
                console.error('‚ùå ÏßÄÎèÑ ÏÉùÏÑ± Ï§ë Ïò§Î•ò:', error);
                showMapError('ÏßÄÎèÑÎ•º ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§<br>' + error.message);
            }
        }
        
        // ÏßÄÎèÑ Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
        function showMapError(message) {
            var mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = '<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8f9fa;border-radius:8px;border:2px dashed #e0e0e0;">' +
                    '<i class="fas fa-exclamation-triangle" style="font-size:48px;color:#ff9800;margin-bottom:15px;"></i>' +
                    '<p style="color:#666;font-size:16px;font-weight:bold;margin-bottom:10px;">ÏßÄÎèÑÎ•º ÌëúÏãúÌï† Ïàò ÏóÜÏäµÎãàÎã§</p>' +
                    '<p style="color:#999;font-size:14px;text-align:center;line-height:1.6;">' + message + '</p>' +
                    '</div>';
            }
        }
    </script>
</body>
</html>
