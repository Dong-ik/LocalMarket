<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전통시장 데이터 가져오기 - LocalMarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
</head>
<body>
    <!-- 헤더 영역 -->
    <div th:replace="~{layout :: header}"></div>

    <!-- 메인 콘텐츠 -->
    <div class="container mt-4">
        <!-- 페이지 제목 -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="mb-0">
                    <i class="fas fa-download text-primary me-2"></i>
                    전통시장 데이터 가져오기
                </h2>
                <p class="text-muted mt-2">공공데이터 포털의 전통시장 정보를 일반시장 데이터베이스로 가져올 수 있습니다.</p>
            </div>
        </div>

        <!-- 가져오기 제어 패널 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>데이터 가져오기 설정
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="importForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="regionSelect" class="form-label">지역 선택</label>
                                    <select class="form-select" id="regionSelect" name="region">
                                        <option value="">전체 지역</option>
                                        <option th:each="region : ${regions}" 
                                                th:value="${region}" 
                                                th:text="${region}"></option>
                                    </select>
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="button" class="btn btn-success me-2" onclick="previewData()">
                                        <i class="fas fa-eye me-2"></i>미리보기
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="importData()">
                                        <i class="fas fa-download me-2"></i>데이터 가져오기
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 결과 표시 영역 -->
        <div id="resultArea" class="row mb-4" style="display: none;">
            <div class="col-12">
                <div id="resultCard" class="card border-0 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>가져오기 결과
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="resultContent">
                            <!-- 결과 내용이 여기에 동적으로 추가됩니다 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 전통시장 미리보기 -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            전통시장 데이터 미리보기 
                            <span class="badge bg-info ms-2" th:text="${#lists.size(traditionalMarkets)} + '개'"></span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>시장명</th>
                                        <th>지역</th>
                                        <th>주소</th>
                                        <th>시장유형</th>
                                        <th>점포수</th>
                                        <th>편의시설</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="market : ${traditionalMarkets}">
                                        <td>
                                            <strong th:text="${market.marketName}"></strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary" th:text="${market.siDoName}"></span>
                                            <br>
                                            <small class="text-muted" th:text="${market.siGunGuName}"></small>
                                        </td>
                                        <td>
                                            <small th:text="${market.detailAddress}"></small>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary" th:text="${market.marketType}"></span>
                                        </td>
                                        <td>
                                            <span th:text="${market.storeCount ?: '-'}"></span>
                                        </td>
                                        <td>
                                            <small th:text="${market.facilitiesAsString}"></small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 설명 섹션 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>안내사항</h6>
                    <ul class="mb-0">
                        <li>전통시장 공공데이터를 일반시장 데이터베이스로 가져올 수 있습니다.</li>
                        <li>중복된 시장명과 지역이 있는 경우 자동으로 제외됩니다.</li>
                        <li>가져온 데이터는 일반시장 목록에서 확인할 수 있습니다.</li>
                        <li>편의시설 정보, 점포수, 영업시간 등이 시장 소개에 포함됩니다.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 푸터 영역 -->
    <div th:replace="~{layout :: footer}"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function previewData() {
            const region = document.getElementById('regionSelect').value;
            const url = region ? `/markets/traditional/region?region=${encodeURIComponent(region)}` : '/markets/traditional';
            window.open(url, '_blank');
        }

        function importData() {
            const region = document.getElementById('regionSelect').value;
            const resultArea = document.getElementById('resultArea');
            const resultContent = document.getElementById('resultContent');
            const resultCard = document.getElementById('resultCard');
            
            // 로딩 표시
            resultArea.style.display = 'block';
            resultCard.className = 'card border-0 shadow-sm border-warning';
            resultContent.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">로딩중...</span>
                    </div>
                    <p class="mt-2 text-muted">전통시장 데이터를 가져오는 중입니다...</p>
                </div>
            `;

            // AJAX 요청
            const formData = new FormData();
            if (region) {
                formData.append('region', region);
            }

            fetch('/markets/import/traditional', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 성공
                    resultCard.className = 'card border-0 shadow-sm border-success';
                    resultContent.innerHTML = `
                        <div class="alert alert-success border-0">
                            <h6><i class="fas fa-check-circle me-2"></i>가져오기 성공!</h6>
                            <p class="mb-2">${data.message}</p>
                            <hr>
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <h4 class="text-success">${data.totalCount}</h4>
                                    <small class="text-muted">전체 전통시장</small>
                                </div>
                                <div class="col-md-4">
                                    <h4 class="text-primary">${data.importedCount}</h4>
                                    <small class="text-muted">새로 가져온 시장</small>
                                </div>
                                <div class="col-md-4">
                                    <h4 class="text-info">${data.totalCount - data.importedCount}</h4>
                                    <small class="text-muted">중복 제외</small>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <a href="/markets/list" class="btn btn-primary">
                                <i class="fas fa-list me-2"></i>일반시장 목록 보기
                            </a>
                        </div>
                    `;
                } else {
                    // 실패
                    resultCard.className = 'card border-0 shadow-sm border-danger';
                    resultContent.innerHTML = `
                        <div class="alert alert-danger border-0">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>가져오기 실패</h6>
                            <p class="mb-0">${data.message}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                // 오류
                resultCard.className = 'card border-0 shadow-sm border-danger';
                resultContent.innerHTML = `
                    <div class="alert alert-danger border-0">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>오류 발생</h6>
                        <p class="mb-0">네트워크 오류가 발생했습니다: ${error.message}</p>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>