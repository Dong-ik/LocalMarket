<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<!-- 헤더 Include -->
<div th:replace="~{common/header}"></div>

<link rel="stylesheet" th:href="@{/css/member.css}">

<div class="container" style="margin-top: 100px; margin-bottom: 60px;">
    <div class="page-header">
        <h1><i class="fas fa-users"></i> 회원 관리</h1>
        <p class="subtitle">전체 회원 목록을 조회하고 관리할 수 있습니다</p>
    </div>
    
    <!-- 검색 영역 -->
    <div class="search-section">
        <div class="search-box">
            <input type="text" id="searchKeyword" placeholder="회원 ID, 이름, 이메일로 검색하세요..." />
            <button onclick="searchMembers()" class="btn-search">
                <i class="fas fa-search"></i> 검색
            </button>
        </div>
        <div class="member-count">
            <i class="fas fa-user-friends"></i>
            전체 회원: <strong th:text="${members.size()}">0</strong>명
        </div>
    </div>
    
    <!-- 등급별 필터 버튼 -->
    <div class="filter-section">
        <button class="filter-btn active" onclick="filterByGrade('ALL')">
            <i class="fas fa-users"></i> 전체
        </button>
        <button class="filter-btn" onclick="filterByGrade('ADMIN')">
            <i class="fas fa-user-shield"></i> 관리자
        </button>
        <button class="filter-btn" onclick="filterByGrade('SELLER')">
            <i class="fas fa-store"></i> 판매자
        </button>
        <button class="filter-btn" onclick="filterByGrade('BUYER')">
            <i class="fas fa-shopping-cart"></i> 구매자
        </button>
    </div>

    <!-- 회원 목록 테이블 -->
    <div class="member-list-container">
        <table class="member-table">
            <thead>
                <tr>
                    <th>번호</th>
                    <th>회원ID</th>
                    <th>이름</th>
                    <th>이메일</th>
                    <th>전화번호</th>
                    <th>주소</th>
                    <th>등급</th>
                    <th>가입일</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="member, stat : ${members}" th:id="'member-row-' + ${member.memberNum}">
                    <td th:text="${stat.count}"></td>
                    <td>
                        <div class="member-id">
                            <i class="fas fa-user-circle"></i>
                            <span th:text="${member.memberId}"></span>
                        </div>
                    </td>
                    <td>
                        <strong th:text="${member.memberName}"></strong>
                    </td>
                    <td>
                        <span class="email" th:text="${member.email}"></span>
                    </td>
                    <td th:text="${member.phone}"></td>
                    <td>
                        <span class="address" th:text="${member.memberAddress}"></span>
                    </td>
                    <td class="grade-cell">
                        <span th:if="${member.memberGrade == 'ADMIN'}" class="grade-badge grade-admin">관리자</span>
                        <span th:if="${member.memberGrade == 'SELLER'}" class="grade-badge grade-seller">판매자</span>
                        <span th:if="${member.memberGrade == 'BUYER'}" class="grade-badge grade-buyer">구매자</span>
                    </td>
                    <td th:text="${#temporals.format(member.createdDate, 'yyyy-MM-dd')}"></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" 
                                    th:data-member-num="${member.memberNum}"
                                    onclick="editMember(this.dataset.memberNum)">
                                <i class="fas fa-edit"></i> 수정
                            </button>
                            <button class="btn-delete" 
                                    th:data-member-num="${member.memberNum}"
                                    th:data-member-name="${member.memberName}"
                                    onclick="deleteMember(this.dataset.memberNum, this.dataset.memberName)">
                                <i class="fas fa-trash"></i> 삭제
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <!-- 데이터 없을 때 -->
        <div th:if="${members.isEmpty()}" class="no-data">
            <i class="fas fa-users-slash"></i>
            <p>등록된 회원이 없습니다.</p>
        </div>
    </div>
</div>

<!-- 푸터 Include -->
<div th:replace="~{common/footer}"></div>

<script>
// 현재 선택된 등급 필터
let currentGradeFilter = 'ALL';

// 회원 검색
function searchMembers() {
    const keyword = document.getElementById('searchKeyword').value.toLowerCase();
    const rows = document.querySelectorAll('.member-table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const gradeCell = row.querySelector('.grade-cell');
        const memberGrade = gradeCell ? gradeCell.textContent.trim() : '';
        
        // 키워드 매치
        const keywordMatch = text.includes(keyword);
        
        // 등급 필터 매치
        let gradeMatch = true;
        if (currentGradeFilter !== 'ALL') {
            const gradeMap = {
                'ADMIN': '관리자',
                'SELLER': '판매자',
                'BUYER': '구매자'
            };
            gradeMatch = memberGrade === gradeMap[currentGradeFilter];
        }
        
        // 둘 다 매치되어야 표시
        if (keywordMatch && gradeMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    updateMemberCount();
}

// 등급별 필터
function filterByGrade(grade) {
    currentGradeFilter = grade;
    
    // 버튼 활성화 상태 변경
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.closest('.filter-btn').classList.add('active');
    
    // 검색 실행
    searchMembers();
}

// 엔터키로 검색
document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchMembers();
    }
});

// 실시간 검색
document.getElementById('searchKeyword').addEventListener('input', function() {
    searchMembers();
});

// 회원 수정
function editMember(memberNum) {
    window.location.href = `/members/${memberNum}/edit`;
}

// 회원 삭제
function deleteMember(memberNum, memberName) {
    if (!confirm(`'${memberName}' 회원을 정말 삭제하시겠습니까?\n\n삭제된 회원 정보는 복구할 수 없습니다.`)) {
        return;
    }
    
    fetch(`/api/members/${memberNum}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // 해당 행 제거
            const row = document.getElementById(`member-row-${memberNum}`);
            if (row) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => {
                    row.remove();
                    // 회원 수 업데이트
                    updateMemberCount();
                }, 300);
            }
        } else {
            alert(data.message || '회원 삭제에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('회원 삭제 중 오류가 발생했습니다.');
    });
}

// 회원 수 업데이트
function updateMemberCount() {
    const visibleRows = document.querySelectorAll('.member-table tbody tr:not([style*="display: none"])');
    const countElement = document.querySelector('.member-count strong');
    if (countElement) {
        countElement.textContent = visibleRows.length;
    }
}
</script>

</html>
