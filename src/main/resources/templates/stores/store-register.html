<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<body>
<!-- í—¤ë” Include -->
<div th:replace="~{common/header}"></div>

<link rel="stylesheet" th:href="@{/css/store-register.css}">

<div class="container" style="margin-top: 100px; margin-bottom: 60px;">
    <div class="page-header">
        <h1><i class="fas fa-store"></i> ê°€ê²Œ ë“±ë¡</h1>
        <p class="subtitle">ìƒˆë¡œìš´ ê°€ê²Œë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>
    
    <div class="form-container">
        <form id="registerForm" onsubmit="registerStore(event)">
            
            <!-- ê°€ê²Œ ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
            <div class="form-group">
                <label>
                    <i class="fas fa-image"></i> ê°€ê²Œ ì´ë¯¸ì§€
                </label>
                <div class="image-upload-container">
                    <div class="image-preview" id="imagePreview">
                        <div class="no-image">
                            <i class="fas fa-image"></i>
                            <p>ì´ë¯¸ì§€ ì—†ìŒ</p>
                        </div>
                    </div>
                    <div class="image-upload-controls">
                        <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)" style="display: none;">
                        <button type="button" onclick="document.getElementById('imageFile').click()" class="btn btn-upload">
                            <i class="fas fa-upload"></i> ì´ë¯¸ì§€ ì„ íƒ
                        </button>
                        <small class="form-help">JPG, PNG, GIF, WEBP í˜•ì‹ (ìµœëŒ€ 5MB)</small>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="storeName">
                    <i class="fas fa-store-alt"></i> ê°€ê²Œëª… <span class="required">*</span>
                </label>
                <input type="text" id="storeName" required placeholder="ê°€ê²Œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label for="storeCategory">
                    <i class="fas fa-tag"></i> ì¹´í…Œê³ ë¦¬ <span class="required">*</span>
                </label>
                <select id="storeCategory" required>
                    <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ìŒì‹ì ">ğŸ½ï¸ ìŒì‹ì </option>
                    <option value="ì˜ë¥˜">ğŸ‘• ì˜ë¥˜</option>
                    <option value="ì‹í’ˆ">ğŸ ì‹í’ˆ</option>
                    <option value="ìƒí™œìš©í’ˆ">ğŸ§º ìƒí™œìš©í’ˆ</option>
                    <option value="ì „ìì œí’ˆ">ğŸ“± ì „ìì œí’ˆ</option>
                    <option value="ì¹´í˜">â˜• ì¹´í˜</option>
                    <option value="ë°˜ë ¤ë™ë¬¼">ğŸ• ë°˜ë ¤ë™ë¬¼</option>
                    <option value="ìŠ¤í¬ì¸ ">âš½ ìŠ¤í¬ì¸ </option>
                    <option value="ê½ƒì§‘">ğŸŒ¸ ê½ƒì§‘</option>
                    <option value="ë¬¸êµ¬">âœï¸ ë¬¸êµ¬</option>
                    <option value="ì•¼ì±„ì„œë¦¬">ğŸ¥¬ ì•¼ì±„ì„œë¦¬</option>
                    <option value="ì•¡ì„¸ì„œë¦¬">ğŸ’ ì•¡ì„¸ì„œë¦¬</option>
                    <option value="ì¡í™”">ğŸ ì¡í™”</option>
                    <option value="ì¥í™”">ğŸ‘¢ ì¥í™”</option>
                    <option value="ê¸°íƒ€">ğŸ“¦ ê¸°íƒ€</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="marketId">
                    <i class="fas fa-shopping-bag"></i> ì†Œì† ì‹œì¥ <span class="required">*</span>
                </label>
                <select id="marketId" required>
                    <option value="">ì‹œì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option th:each="market : ${markets}" 
                            th:value="${market.marketId}" 
                            th:text="${market.marketName + ' (' + market.marketLocal + ')'}"></option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="memberSearch">
                    <i class="fas fa-user-tie"></i> íŒë§¤ì <span class="required">*</span>
                </label>
                <div class="search-input-container">
                    <input type="text" id="memberSearch" placeholder="íŒë§¤ì ì´ë¦„ ë˜ëŠ” IDë¡œ ê²€ìƒ‰..." autocomplete="off" required>
                    <input type="hidden" id="memberNum" required>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <small class="form-help">ì„ íƒëœ íŒë§¤ì: <strong id="selectedMember">ì—†ìŒ</strong></small>
            </div>
            
            <div class="form-group">
                <label for="storeIndex">
                    <i class="fas fa-map-marker-alt"></i> ê°€ê²Œ ìœ„ì¹˜ <span class="required">*</span>
                </label>
                <input type="text" id="storeIndex" required placeholder="ì˜ˆ: Aë™ 123í˜¸, 1ì¸µ 5ë²ˆ">
                <small class="form-help">ì‹œì¥ ë‚´ ê°€ê²Œì˜ ìœ„ì¹˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</small>
            </div>
            
            <div class="form-actions">
                <button type="button" onclick="location.href='/stores/adminlist'" class="btn btn-secondary">
                    <i class="fas fa-times"></i> ì·¨ì†Œ
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i> ë“±ë¡
                </button>
            </div>
        </form>
    </div>
</div>

<div th:replace="~{common/footer}"></div>

<script th:inline="javascript">
// íŒë§¤ì ëª©ë¡ ë°ì´í„° (Thymeleafì—ì„œ ì „ë‹¬)
const sellers = /*[[${sellers}]]*/ [];

// ë””ë²„ê¹…ìš© - ì½˜ì†”ì— ë°ì´í„° ì¶œë ¥
console.log('=== ê°€ê²Œ ë“±ë¡ í˜ì´ì§€ ë””ë²„ê¹… ===');
console.log('íŒë§¤ì ëª©ë¡:', sellers);
console.log('íŒë§¤ì ìˆ˜:', sellers ? sellers.length : 0);

// ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.innerHTML = `<img src="${e.target.result}" alt="ë¯¸ë¦¬ë³´ê¸°" id="previewImg">`;
        };
        reader.readAsDataURL(file);
    }
}

// íŒë§¤ì ê²€ìƒ‰ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('memberSearch');
    const searchResults = document.getElementById('searchResults');
    const memberNumInput = document.getElementById('memberNum');
    const selectedMemberSpan = document.getElementById('selectedMember');
    
    // ê²€ìƒ‰ ì…ë ¥ ì‹œ
    searchInput.addEventListener('input', function() {
        const keyword = this.value.toLowerCase().trim();
        
        if (keyword.length === 0) {
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            return;
        }
        
        // íŒë§¤ì í•„í„°ë§
        const filtered = sellers.filter(seller => {
            const name = (seller.memberName || '').toLowerCase();
            const id = (seller.memberId || '').toLowerCase();
            return name.includes(keyword) || id.includes(keyword);
        });
        
        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        if (filtered.length > 0) {
            searchResults.innerHTML = filtered.map(seller => `
                <div class="search-result-item" onclick="selectMember(${seller.memberNum}, '${seller.memberName}', '${seller.memberId}')">
                    <div class="seller-name">${seller.memberName}</div>
                    <div class="seller-id">${seller.memberId}</div>
                </div>
            `).join('');
            searchResults.style.display = 'block';
        } else {
            searchResults.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            searchResults.style.display = 'block';
        }
    });
    
    // ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²°ê³¼ ë‹«ê¸°
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
});

// íŒë§¤ì ì„ íƒ
function selectMember(memberNum, memberName, memberId) {
    document.getElementById('memberNum').value = memberNum;
    document.getElementById('memberSearch').value = memberName + ' (' + memberId + ')';
    document.getElementById('selectedMember').textContent = memberName + ' (' + memberId + ')';
    document.getElementById('searchResults').style.display = 'none';
}

// ê°€ê²Œ ë“±ë¡
// ì´ë¯¸ì§€ ì €ì¥ ê²½ë¡œ: src/main/static/images/stores/
function registerStore(event) {
    event.preventDefault();
    
    const formData = new FormData();
    const imageFile = document.getElementById('imageFile').files[0];
    
    // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ FormDataì— ì¶”ê°€
    // ì„œë²„ëŠ” images/stores/ ë””ë ‰í† ë¦¬ì— ì €ì¥í•´ì•¼ í•¨
    if (imageFile) {
        formData.append('file', imageFile);
    }
    
    // ê°€ê²Œ ë°ì´í„°ë¥¼ ê°œë³„ íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€
    formData.append('storeName', document.getElementById('storeName').value);
    formData.append('storeCategory', document.getElementById('storeCategory').value);
    formData.append('marketId', document.getElementById('marketId').value);
    formData.append('memberNum', document.getElementById('memberNum').value);
    formData.append('storeIndex', document.getElementById('storeIndex').value);
    
    // ë“±ë¡ ë²„íŠ¼ ë¹„í™œì„±í™”
    const submitBtn = event.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ë“±ë¡ ì¤‘...';
    
    fetch('/api/stores', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'ê°€ê²Œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/stores/adminlist';
        } else {
            alert(data.message || 'ê°€ê²Œ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check"></i> ë“±ë¡';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ê°€ê²Œ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check"></i> ë“±ë¡';
    });
}
</script>

</body>
</html>
