<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<!-- í—¤ë” Include -->
<div th:replace="~{common/header}"></div>

<link rel="stylesheet" th:href="@{/css/store-register.css}">

<div class="container" style="margin-top: 100px; margin-bottom: 60px;">
    <div class="page-header">
        <h1><i class="fas fa-store"></i> ê°€ê²Œ ì •ë³´ ìˆ˜ì •</h1>
        <p class="subtitle">ê°€ê²Œ ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>
    
    <div class="form-container">
        <form id="editForm" onsubmit="updateStore(event)">
            <input type="hidden" id="storeId" th:value="${store.storeId}">
            
            <!-- ê°€ê²Œ ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
            <div class="form-group">
                <label>
                    <i class="fas fa-image"></i> ê°€ê²Œ ì´ë¯¸ì§€
                </label>
                <div class="image-upload-container">
                    <div class="image-preview" id="imagePreview">
                        <img th:if="${store.storeFilename != null}" 
                             th:src="@{'/images/stores/' + ${store.storeFilename}}" 
                             alt="ê°€ê²Œ ì´ë¯¸ì§€"
                             id="previewImg">
                        <div th:unless="${store.storeFilename != null}" class="no-image">
                            <i class="fas fa-image"></i>
                            <p>ì´ë¯¸ì§€ ì—†ìŒ</p>
                        </div>
                    </div>
                    <div class="image-upload-controls">
                        <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event)" style="display: none;">
                        <button type="button" onclick="document.getElementById('imageFile').click()" class="btn btn-upload">
                            <i class="fas fa-upload"></i> ì´ë¯¸ì§€ ì„ íƒ
                        </button>
                        <button type="button" onclick="uploadImage()" class="btn btn-success" id="uploadBtn" style="display: none;">
                            <i class="fas fa-check"></i> ì—…ë¡œë“œ
                        </button>
                        <small class="form-help">JPG, PNG, GIF, WEBP í˜•ì‹ (ìµœëŒ€ 5MB)</small>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="storeName">
                    <i class="fas fa-store-alt"></i> ê°€ê²Œëª… <span class="required">*</span>
                </label>
                <input type="text" id="storeName" th:value="${store.storeName}" required>
            </div>
            
            <div class="form-group">
                <label for="storeCategory">
                    <i class="fas fa-tag"></i> ì¹´í…Œê³ ë¦¬ <span class="required">*</span>
                </label>
                <select id="storeCategory" required>
                    <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ìŒì‹ì " th:selected="${store.storeCategory == 'ìŒì‹ì '}">ğŸ½ï¸ ìŒì‹ì </option>
                    <option value="ì˜ë¥˜" th:selected="${store.storeCategory == 'ì˜ë¥˜'}">ğŸ‘• ì˜ë¥˜</option>
                    <option value="ì‹í’ˆ" th:selected="${store.storeCategory == 'ì‹í’ˆ'}">ğŸ ì‹í’ˆ</option>
                    <option value="ìƒí™œìš©í’ˆ" th:selected="${store.storeCategory == 'ìƒí™œìš©í’ˆ'}">ğŸ§º ìƒí™œìš©í’ˆ</option>
                    <option value="ì „ìì œí’ˆ" th:selected="${store.storeCategory == 'ì „ìì œí’ˆ'}">ğŸ“± ì „ìì œí’ˆ</option>
                    <option value="ì¹´í˜" th:selected="${store.storeCategory == 'ì¹´í˜'}">â˜• ì¹´í˜</option>
                    <option value="ë°˜ë ¤ë™ë¬¼" th:selected="${store.storeCategory == 'ë°˜ë ¤ë™ë¬¼'}">ğŸ• ë°˜ë ¤ë™ë¬¼</option>
                    <option value="ìŠ¤í¬ì¸ " th:selected="${store.storeCategory == 'ìŠ¤í¬ì¸ '}">âš½ ìŠ¤í¬ì¸ </option>
                    <option value="ê½ƒì§‘" th:selected="${store.storeCategory == 'ê½ƒì§‘'}">ğŸŒ¸ ê½ƒì§‘</option>
                    <option value="ë¬¸êµ¬" th:selected="${store.storeCategory == 'ë¬¸êµ¬'}">âœï¸ ë¬¸êµ¬</option>
                    <option value="ì•¼ì±„ì„œë¦¬" th:selected="${store.storeCategory == 'ì•¼ì±„ì„œë¦¬'}">ğŸ¥¬ ì•¼ì±„ì„œë¦¬</option>
                    <option value="ì•¡ì„¸ì„œë¦¬" th:selected="${store.storeCategory == 'ì•¡ì„¸ì„œë¦¬'}">ğŸ’ ì•¡ì„¸ì„œë¦¬</option>
                    <option value="ì¡í™”" th:selected="${store.storeCategory == 'ì¡í™”'}">ğŸ ì¡í™”</option>
                    <option value="ì¥í™”" th:selected="${store.storeCategory == 'ì¥í™”'}">ğŸ‘¢ ì¥í™”</option>
                    <option value="ê¸°íƒ€" th:selected="${store.storeCategory == 'ê¸°íƒ€'}">ğŸ“¦ ê¸°íƒ€</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="marketId">
                    <i class="fas fa-shopping-bag"></i> ì†Œì† ì‹œì¥ <span class="required">*</span>
                </label>
                <select id="marketId" required>
                    <option value="">ì‹œì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option th:each="market : ${markets}" 
                            th:value="${market.marketId}"
                            th:selected="${market.marketId == store.marketId}"
                            th:text="${market.marketName + ' (' + market.marketLocal + ')'}"></option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="memberSearch">
                    <i class="fas fa-user-tie"></i> íŒë§¤ì <span class="required">*</span>
                </label>
                <div class="search-input-container">
                    <input type="text" 
                           id="memberSearch" 
                           placeholder="íŒë§¤ì ì´ë¦„ ë˜ëŠ” IDë¡œ ê²€ìƒ‰..." 
                           autocomplete="off" 
                           required
                           th:value="${store.memberName != null and store.memberId != null ? store.memberName + ' (' + store.memberId + ')' : ''}">
                    <input type="hidden" id="memberNum" th:value="${store.memberNum}" required>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <small class="form-help">ì„ íƒëœ íŒë§¤ì: <strong id="selectedMember" th:text="${store.memberName != null ? store.memberName + ' (' + store.memberId + ')' : 'ì—†ìŒ'}">ì—†ìŒ</strong></small>
            </div>
            
            <div class="form-group">
                <label for="storeIndex">
                    <i class="fas fa-map-marker-alt"></i> ê°€ê²Œ ìœ„ì¹˜ <span class="required">*</span>
                </label>
                <input type="text" id="storeIndex" th:value="${store.storeIndex}" required>
                <small class="form-help">ì‹œì¥ ë‚´ ê°€ê²Œì˜ ìœ„ì¹˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</small>
            </div>
            
            <div class="form-actions">
                <button type="button" onclick="location.href='/stores/adminlist'" class="btn btn-secondary">
                    <i class="fas fa-times"></i> ì·¨ì†Œ
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> ì €ì¥
                </button>
            </div>
        </form>
    </div>
</div>

<div th:replace="~{common/footer}"></div>

<script th:inline="javascript">
(function() {
    // íŒë§¤ì ëª©ë¡ ë°ì´í„° (Thymeleafì—ì„œ ì „ë‹¬)
    const sellersData = /*[[${sellers}]]*/ [];
    const storeMemberNum = /*[[${store.memberNum}]]*/ null;
    const storeMemberName = /*[[${store.memberName}]]*/ '';
    const storeMemberId = /*[[${store.memberId}]]*/ '';

    // ë””ë²„ê¹…ìš© - ì½˜ì†”ì— ë°ì´í„° ì¶œë ¥
    console.log('=== ê°€ê²Œ ìˆ˜ì • í˜ì´ì§€ ë””ë²„ê¹… ===');
    console.log('Store ë°ì´í„°:', {
        storeId: /*[[${store.storeId}]]*/ null,
        storeName: /*[[${store.storeName}]]*/ '',
        storeCategory: /*[[${store.storeCategory}]]*/ '',
        marketId: /*[[${store.marketId}]]*/ null,
        memberNum: storeMemberNum,
        memberName: storeMemberName,
        memberId: storeMemberId
    });
    console.log('íŒë§¤ì ëª©ë¡:', sellersData);

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
    window.previewImage = function(event) {
    const file = event.target.files[0];
    if (file) {
        // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            event.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.innerHTML = `<img src="${e.target.result}" alt="ë¯¸ë¦¬ë³´ê¸°" id="previewImg">`;
            document.getElementById('uploadBtn').style.display = 'inline-block';
        };
        reader.readAsDataURL(file);
    }
    };

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ
    window.uploadImage = function() {
    const fileInput = document.getElementById('imageFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const storeId = document.getElementById('storeId').value;
    const formData = new FormData();
    formData.append('file', file);
    
    // ì—…ë¡œë“œ ë²„íŠ¼ ë¹„í™œì„±í™”
    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì—…ë¡œë“œ ì¤‘...';
    
    fetch(`/api/stores/${storeId}/upload-image`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            uploadBtn.style.display = 'none';
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-check"></i> ì—…ë¡œë“œ';
            fileInput.value = '';
        } else {
            alert(data.message || 'ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-check"></i> ì—…ë¡œë“œ';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-check"></i> ì—…ë¡œë“œ';
    });
    };

    // íŒë§¤ì ê²€ìƒ‰ ê¸°ëŠ¥
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('memberSearch');
        const searchResults = document.getElementById('searchResults');
        const memberNumInput = document.getElementById('memberNum');
        const selectedMemberSpan = document.getElementById('selectedMember');
        
        // ì´ˆê¸°ê°’ì€ ì´ë¯¸ Thymeleaf th:valueë¡œ ì„¤ì •ë¨
        // ë§Œì•½ ê°’ì´ ì—†ìœ¼ë©´ sellers ë°°ì—´ì—ì„œ ì°¾ì•„ì„œ ì„¤ì •
        if (storeMemberNum && (!searchInput.value || searchInput.value.trim() === '')) {
            const seller = sellersData.find(s => s.memberNum === storeMemberNum);
            if (seller) {
                searchInput.value = seller.memberName + ' (' + seller.memberId + ')';
                selectedMemberSpan.textContent = seller.memberName + ' (' + seller.memberId + ')';
            }
        }
        
        // ê²€ìƒ‰ ì…ë ¥ ì‹œ
        searchInput.addEventListener('input', function() {
            const keyword = this.value.toLowerCase().trim();
            
            console.log('ê²€ìƒ‰ í‚¤ì›Œë“œ:', keyword);
            console.log('íŒë§¤ì ëª©ë¡:', sellersData);
            
            if (keyword.length === 0) {
                searchResults.style.display = 'none';
                searchResults.innerHTML = '';
                return;
            }
            
            // íŒë§¤ì í•„í„°ë§
            const filtered = sellersData.filter(seller => {
                const name = (seller.memberName || '').toLowerCase();
                const id = (seller.memberId || '').toLowerCase();
                const match = name.includes(keyword) || id.includes(keyword);
                console.log(`íŒë§¤ì: ${seller.memberName} (${seller.memberId}) - ë§¤ì¹­: ${match}`);
                return match;
            });
            
            console.log('í•„í„°ë§ëœ ê²°ê³¼:', filtered);
        
        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        if (filtered.length > 0) {
            searchResults.innerHTML = filtered.map(seller => `
                <div class="search-result-item" onclick="selectMember(${seller.memberNum}, '${seller.memberName}', '${seller.memberId}')">
                    <div class="seller-name">${seller.memberName}</div>
                    <div class="seller-id">${seller.memberId}</div>
                </div>
            `).join('');
            searchResults.style.display = 'block';
        } else {
            searchResults.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            searchResults.style.display = 'block';
        }
    });
    
    // ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ê²°ê³¼ ë‹«ê¸°
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
        });
    });

    // íŒë§¤ì ì„ íƒ
    window.selectMember = function(memberNum, memberName, memberId) {
        document.getElementById('memberNum').value = memberNum;
        document.getElementById('memberSearch').value = memberName + ' (' + memberId + ')';
        document.getElementById('selectedMember').textContent = memberName + ' (' + memberId + ')';
        document.getElementById('searchResults').style.display = 'none';
    };

    // ê°€ê²Œ ì •ë³´ ìˆ˜ì •
    window.updateStore = function(event) {
    event.preventDefault();
    
    const storeId = document.getElementById('storeId').value;
    const storeData = {
        storeName: document.getElementById('storeName').value,
        storeCategory: document.getElementById('storeCategory').value,
        marketId: document.getElementById('marketId').value,
        memberNum: document.getElementById('memberNum').value,
        storeIndex: document.getElementById('storeIndex').value
    };
    
    fetch(`/api/stores/${storeId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(storeData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = '/stores/adminlist';
        } else {
            alert(data.message || 'ê°€ê²Œ ì •ë³´ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ê°€ê²Œ ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
    };

})(); // ì¦‰ì‹œ ì‹¤í–‰ í•¨ìˆ˜ ì¢…ë£Œ
</script>

</body>
</html>
