<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>주문/결제 관리 - LocalMarket</title>
    <link rel="stylesheet" th:href="@{/css/admin-order.css}">
</head>
<body>

<!-- 헤더 Include -->
<div th:replace="~{common/header}"></div>

<div class="container" style="margin-top: 100px; margin-bottom: 60px;">
    <div class="page-header">
        <h1><i class="fas fa-receipt"></i> 주문/결제 관리</h1>
        <p class="subtitle">전체 주문 내역을 관리하고 결제 상태를 확인할 수 있습니다</p>
    </div>

    <!-- 메시지 표시 -->
    <div th:if="${message}" class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <span th:text="${message}"></span>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i>
        <span th:text="${errorMessage}"></span>
    </div>

    <!-- 검색 및 필터 섹션 -->
    <div class="filter-section">
        <!-- 검색 -->
        <div class="search-group">
            <label for="searchInput"><i class="fas fa-search"></i> 검색:</label>
            <input type="text"
                   id="searchInput"
                   class="search-input"
                   placeholder="주문번호, 회원명, 거래ID 검색"
                   th:value="${searchKeyword}">
            <button class="btn-search" onclick="performSearch()">
                <i class="fas fa-search"></i> 검색
            </button>
        </div>

        <!-- 주문 상태 선택 -->
        <div class="filter-group">
            <label for="orderStatusSelect"><i class="fas fa-truck"></i> 주문상태:</label>
            <select id="orderStatusSelect" class="filter-select" onchange="applyFilters()">
                <option value="">전체</option>
                <option value="결제대기" th:selected="${selectedOrderStatus == '결제대기'}">결제대기</option>
                <option value="결제완료" th:selected="${selectedOrderStatus == '결제완료'}">결제완료</option>
                <option value="배송준비중" th:selected="${selectedOrderStatus == '배송준비중'}">배송준비중</option>
                <option value="배송중" th:selected="${selectedOrderStatus == '배송중'}">배송중</option>
                <option value="배송완료" th:selected="${selectedOrderStatus == '배송완료'}">배송완료</option>
                <option value="취소" th:selected="${selectedOrderStatus == '취소'}">취소</option>
            </select>
        </div>

        <!-- 결제 상태 선택 -->
        <div class="filter-group">
            <label for="paymentStatusSelect"><i class="fas fa-credit-card"></i> 결제상태:</label>
            <select id="paymentStatusSelect" class="filter-select" onchange="applyFilters()">
                <option value="">전체</option>
                <option value="PENDING" th:selected="${selectedPaymentStatus == 'PENDING'}">결제대기</option>
                <option value="COMPLETED" th:selected="${selectedPaymentStatus == 'COMPLETED'}">결제완료</option>
                <option value="CANCELLED" th:selected="${selectedPaymentStatus == 'CANCELLED'}">결제취소</option>
                <option value="FAILED" th:selected="${selectedPaymentStatus == 'FAILED'}">결제실패</option>
            </select>
        </div>

        <!-- 주문 개수 표시 -->
        <div class="order-count">
            <i class="fas fa-shopping-cart"></i>
            총 주문: <strong th:text="${orders.size()}">0</strong>건
        </div>
    </div>

    <!-- 주문 목록 테이블 -->
    <div class="order-list-container" th:if="${!orders.isEmpty()}">
        <table class="order-table">
            <thead>
                <tr>
                    <th>주문번호</th>
                    <th>주문자</th>
                    <th>상품정보</th>
                    <th>주문금액</th>
                    <th>배송비</th>
                    <th>결제방법</th>
                    <th>결제상태</th>
                    <th>주문상태</th>
                    <th>주문일시</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="order : ${orders}" th:id="'order-row-' + ${order.orderId}">
                    <td>
                        <div class="order-id">
                            <i class="fas fa-hashtag"></i>
                            <span th:text="${order.orderId}"></span>
                        </div>
                        <div class="transaction-id" th:if="${order.transactionId}">
                            <small th:text="'거래ID: ' + ${order.transactionId}"></small>
                        </div>
                    </td>
                    <td>
                        <div class="member-info">
                            <i class="fas fa-user"></i>
                            <span th:text="${order.memberName}">회원명</span>
                        </div>
                        <div class="member-num">
                            <small th:text="'회원번호: ' + ${order.memberNum}"></small>
                        </div>
                    </td>
                    <td>
                        <div class="order-items">
                            <div th:if="${order.orderDetails != null && !order.orderDetails.isEmpty()}">
                                <div class="product-info" th:each="detail, iterStat : ${order.orderDetails}"
                                     th:if="${iterStat.index < 2}">
                                    <img th:if="${detail.productImage != null}"
                                         th:src="${detail.productImage}"
                                         alt="상품 이미지"
                                         class="product-image"
                                         onerror="this.src='/images/no-image.jpg'">
                                    <div class="product-details">
                                        <strong th:text="${detail.productName}">상품명</strong>
                                        <small th:text="'수량: ' + ${detail.orderQuantity} + '개'">수량: 1개</small>
                                    </div>
                                </div>
                                <div th:if="${order.orderDetails.size() > 2}" class="more-items">
                                    <small th:text="'외 ' + ${order.orderDetails.size() - 2} + '건'"></small>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="text-right">
                        <strong class="price" th:text="${#numbers.formatDecimal(order.orderTotalPrice, 0, 'COMMA', 0, 'POINT')} + '원'">0원</strong>
                    </td>
                    <td class="text-right">
                        <span th:text="${order.orderDeliveryFee != null ? #numbers.formatDecimal(order.orderDeliveryFee, 0, 'COMMA', 0, 'POINT') + '원' : '0원'}">0원</span>
                    </td>
                    <td>
                        <div class="payment-method">
                            <i class="fas fa-credit-card"></i>
                            <span th:text="${order.paymentMethod != null ? order.paymentMethod : '미지정'}">미지정</span>
                        </div>
                    </td>
                    <td class="status-cell">
                        <span th:if="${order.paymentStatus == 'PENDING'}" class="status-badge payment-pending">결제대기</span>
                        <span th:if="${order.paymentStatus == 'COMPLETED'}" class="status-badge payment-completed">결제완료</span>
                        <span th:if="${order.paymentStatus == 'CANCELLED'}" class="status-badge payment-cancelled">결제취소</span>
                        <span th:if="${order.paymentStatus == 'FAILED'}" class="status-badge payment-failed">결제실패</span>
                    </td>
                    <td class="status-cell">
                        <span th:if="${order.orderStatus == '결제대기'}" class="status-badge status-pending">결제대기</span>
                        <span th:if="${order.orderStatus == '결제완료'}" class="status-badge status-paid">결제완료</span>
                        <span th:if="${order.orderStatus == '배송준비중'}" class="status-badge status-preparing">배송준비중</span>
                        <span th:if="${order.orderStatus == '배송중'}" class="status-badge status-shipping">배송중</span>
                        <span th:if="${order.orderStatus == '배송완료'}" class="status-badge status-delivered">배송완료</span>
                        <span th:if="${order.orderStatus == '취소'}" class="status-badge status-cancelled">취소</span>
                    </td>
                    <td>
                        <div th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd')}">2024-01-01</div>
                        <small th:text="${#temporals.format(order.orderDate, 'HH:mm')}">12:00</small>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-detail"
                                    th:onclick="|viewOrderDetail(${order.orderId})|">
                                <i class="fas fa-eye"></i> 상세
                            </button>
                            <button class="btn-status"
                                    th:onclick="|showStatusModal(${order.orderId}, '${order.orderStatus}')|">
                                <i class="fas fa-edit"></i> 상태변경
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 데이터 없을 때 -->
    <div th:if="${orders.isEmpty()}" class="no-data">
        <i class="fas fa-inbox"></i>
        <p>주문 내역이 없습니다.</p>
    </div>
</div>

<!-- 주문 상태 변경 모달 -->
<div id="statusModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> 주문 상태 변경</h2>
            <span class="close" onclick="closeStatusModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="newOrderStatus">새로운 주문 상태:</label>
                <select id="newOrderStatus" class="modal-select">
                    <option value="결제대기">결제대기</option>
                    <option value="결제완료">결제완료</option>
                    <option value="배송준비중">배송준비중</option>
                    <option value="배송중">배송중</option>
                    <option value="배송완료">배송완료</option>
                    <option value="취소">취소</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeStatusModal()">취소</button>
            <button class="btn-confirm" onclick="updateOrderStatus()">변경</button>
        </div>
    </div>
</div>

<!-- 푸터 Include -->
<div th:replace="~{common/footer}"></div>

<script>
let selectedOrderId = null;

// 검색 수행
function performSearch() {
    const searchValue = document.getElementById('searchInput').value;
    applyFilters();
}

// 필터 적용
function applyFilters() {
    const orderStatus = document.getElementById('orderStatusSelect').value;
    const paymentStatus = document.getElementById('paymentStatusSelect').value;
    const search = document.getElementById('searchInput').value;

    let url = '/order/adminlist';
    const params = [];

    if (orderStatus) {
        params.push('orderStatus=' + encodeURIComponent(orderStatus));
    }
    if (paymentStatus) {
        params.push('paymentStatus=' + encodeURIComponent(paymentStatus));
    }
    if (search) {
        params.push('search=' + encodeURIComponent(search));
    }

    if (params.length > 0) {
        url += '?' + params.join('&');
    }

    window.location.href = url;
}

// 주문 상세 보기
function viewOrderDetail(orderId) {
    window.location.href = '/order/detail/' + orderId;
}

// 상태 변경 모달 표시
function showStatusModal(orderId, currentStatus) {
    selectedOrderId = orderId;
    document.getElementById('newOrderStatus').value = currentStatus;
    document.getElementById('statusModal').style.display = 'block';
}

// 모달 닫기
function closeStatusModal() {
    document.getElementById('statusModal').style.display = 'none';
    selectedOrderId = null;
}

// 주문 상태 업데이트
function updateOrderStatus() {
    if (!selectedOrderId) return;

    const newStatus = document.getElementById('newOrderStatus').value;

    fetch(`/api/order/${selectedOrderId}/status?status=${encodeURIComponent(newStatus)}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.ok) {
            alert('주문 상태가 변경되었습니다.');
            location.reload();
        } else {
            alert('주문 상태 변경에 실패했습니다.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('오류가 발생했습니다.');
    });

    closeStatusModal();
}

// 모달 외부 클릭 시 닫기
window.onclick = function(event) {
    const modal = document.getElementById('statusModal');
    if (event.target === modal) {
        closeStatusModal();
    }
}

// 엔터 키로 검색
document.getElementById('searchInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        performSearch();
    }
});
</script>

</body>
</html>
