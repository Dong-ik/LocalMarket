<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문/결제 관리 - LocalMarket</title>
    <link rel="stylesheet" th:href="@{/css/admin-order.css}">
</head>
<body>

<!-- 헤더 Include -->
<div th:replace="~{common/header}"></div>

<div class="container" style="margin-top: 100px; margin-bottom: 60px;">
    <div class="page-header">
        <h1><i class="fas fa-receipt"></i> 주문/결제 관리</h1>
        <p class="subtitle">전체 주문 내역을 관리하고 결제 상태를 확인할 수 있습니다</p>
    </div>

    <!-- 메시지 표시 -->
    <div th:if="${message}" class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <span th:text="${message}"></span>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger">
        <i class="fas fa-exclamation-circle"></i>
        <span th:text="${errorMessage}"></span>
    </div>

    <!-- 검색 및 필터 섹션 -->
    <div class="filter-section">
        <!-- 검색 -->
        <div class="search-group">
            <label for="searchInput"><i class="fas fa-search"></i> 검색:</label>
            <input type="text"
                   id="searchInput"
                   class="search-input"
                   placeholder="주문번호, 회원명, 거래ID 검색"
                   th:value="${searchKeyword}">
            <button class="btn-search" onclick="performSearch()">
                <i class="fas fa-search"></i> 검색
            </button>
        </div>

        <!-- 주문 상태 선택 -->
        <div class="filter-group">
            <label for="orderStatusSelect"><i class="fas fa-credit-card"></i> 주문상태:</label>
            <select id="orderStatusSelect" class="filter-select" onchange="applyFilters()">
                <option value="">전체</option>
                <option value="PENDING" th:selected="${selectedOrderStatus == 'PENDING'}">결제대기</option>
                <option value="COMPLETED" th:selected="${selectedOrderStatus == 'COMPLETED'}">결제완료</option>
                <option value="PROCESSING" th:selected="${selectedOrderStatus == 'PROCESSING'}">배송준비</option>
                <option value="SHIPPED" th:selected="${selectedOrderStatus == 'SHIPPED'}">배송중</option>
                <option value="DELIVERED" th:selected="${selectedOrderStatus == 'DELIVERED'}">배송완료</option>
                <option value="RETURN" th:selected="${selectedOrderStatus == 'RETURN'}">반품신청</option>
                <option value="SWAP" th:selected="${selectedOrderStatus == 'SWAP'}">교환신청</option>
                <option value="CANCELLED" th:selected="${selectedOrderStatus == 'CANCELLED'}">주문취소</option>
                <option value="FAILED" th:selected="${selectedOrderStatus == 'FAILED'}">결제실패</option>
            </select>
        </div>

        <!-- 주문 개수 표시 -->
        <div class="order-count">
            <i class="fas fa-shopping-cart"></i>
            총 주문: <strong th:text="${orders.size()}">0</strong>건
        </div>
    </div>

    <!-- 주문 목록 테이블 -->
    <div class="order-list-container" th:if="${!orders.isEmpty()}">
        <table class="order-table">
            <thead>
                <tr>
                    <th>주문번호</th>
                    <th>주문자</th>
                    <th>상품정보</th>
                    <th>주문금액</th>
                    <th>배송비</th>
                    <th>결제방법</th>
                    <th>주문상태</th>
                    <th>주문일시</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="order : ${orders}" th:id="'order-row-' + ${order.orderId}">
                    <td>
                        <div class="order-id">
                            <i class="fas fa-hashtag"></i>
                            <span th:text="${order.orderId}"></span>
                        </div>
                        <div class="transaction-id" th:if="${order.transactionId}">
                            <small th:text="'거래ID: ' + ${order.transactionId}"></small>
                        </div>
                    </td>
                    <td>
                        <div class="member-info">
                            <i class="fas fa-user"></i>
                            <span th:text="${order.memberName}">회원명</span>
                        </div>
                        <div class="member-num">
                            <small th:text="'회원번호: ' + ${order.memberNum}"></small>
                        </div>
                    </td>
                    <td>
                        <div class="order-items">
                            <div th:if="${order.orderDetails != null && !order.orderDetails.isEmpty()}">
                                <div class="product-info" th:each="detail, iterStat : ${order.orderDetails}"
                                     th:if="${iterStat.index < 2}">
                                    <img th:if="${detail.productImage != null}"
                                         th:src="${detail.productImage}"
                                         alt="상품 이미지"
                                         class="product-image-admin"
                                         onerror="this.src='/images/no-image.jpg'">
                                    <div class="product-details">
                                        <strong th:text="${detail.productName}">상품명</strong>
                                        <small th:text="'수량: ' + ${detail.orderQuantity} + '개'">수량: 1개</small>
                                    </div>
                                </div>
                                <div th:if="${order.orderDetails.size() > 2}" class="more-items">
                                    <small th:text="'외 ' + ${order.orderDetails.size() - 2} + '건'"></small>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="text-right">
                        <strong class="price" th:text="${#numbers.formatDecimal(order.orderTotalPrice, 0, 'COMMA', 0, 'POINT')} + '원'">0원</strong>
                    </td>
                    <td class="text-right">
                        <span th:text="${order.orderDeliveryFee != null ? #numbers.formatDecimal(order.orderDeliveryFee, 0, 'COMMA', 0, 'POINT') + '원' : '0원'}">0원</span>
                    </td>
                    <td>
                        <div class="payment-method">
                            <i class="fas fa-credit-card"></i>
                            <span th:text="${order.paymentMethod != null ? order.paymentMethod : '미지정'}">미지정</span>
                        </div>
                    </td>
                    <td class="status-cell">
                        <span th:if="${order.orderStatus == 'PENDING'}" class="status-badge payment-pending">결제대기</span>
                        <span th:if="${order.orderStatus == 'COMPLETED'}" class="status-badge payment-completed">결제완료</span>
                        <span th:if="${order.orderStatus == 'PROCESSING'}" class="status-badge status-preparing">배송준비</span>
                        <span th:if="${order.orderStatus == 'SHIPPED'}" class="status-badge status-shipping">배송중</span>
                        <span th:if="${order.orderStatus == 'DELIVERED'}" class="status-badge status-delivered">배송완료</span>
                        <span th:if="${order.orderStatus == 'RETURN'}" class="status-badge status-return">반품신청</span>
                        <span th:if="${order.orderStatus == 'SWAP'}" class="status-badge status-swap">교환신청</span>
                        <span th:if="${order.orderStatus == 'CANCELLED'}" class="status-badge payment-cancelled">주문취소</span>
                        <span th:if="${order.orderStatus == 'FAILED'}" class="status-badge payment-failed">결제실패</span>
                    </td>
                    <td>
                        <div th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd')}">2024-01-01</div>
                        <small th:text="${#temporals.format(order.orderDate, 'HH:mm')}">12:00</small>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-detail"
                                    th:data-order-id="${order.orderId}"
                                    onclick="viewOrderDetail(this.dataset.orderId)">
                                <i class="fas fa-eye"></i> 상세보기
                            </button>
                            <div class="status-change-wrapper" th:if="${order.orderStatus != 'CANCELLED'}">
                                <button class="btn-status"
                                        th:id="'status-btn-' + ${order.orderId}"
                                        th:data-order-id="${order.orderId}"
                                        onclick="toggleStatusDropdown(this)">
                                    <i class="fas fa-exchange-alt"></i> 상태변경
                                </button>
                                <select class="status-dropdown"
                                        th:id="'status-select-' + ${order.orderId}"
                                        th:data-order-id="${order.orderId}"
                                        onchange="changeOrderStatus(this)"
                                        style="display: none;">
                                    <option value="">선택하세요</option>
                                    <option value="PENDING" th:selected="${order.orderStatus == 'PENDING'}">결제대기</option>
                                    <option value="COMPLETED" th:selected="${order.orderStatus == 'COMPLETED'}">결제완료</option>
                                    <option value="PROCESSING" th:selected="${order.orderStatus == 'PROCESSING'}">배송준비</option>
                                    <option value="SHIPPED" th:selected="${order.orderStatus == 'SHIPPED'}">배송중</option>
                                    <option value="DELIVERED" th:selected="${order.orderStatus == 'DELIVERED'}">배송완료</option>
                                </select>
                            </div>
                            <button class="btn-cancel"
                                    th:data-order-id="${order.orderId}"
                                    onclick="cancelOrder(this.dataset.orderId)"
                                    th:if="${order.orderStatus != 'CANCELLED'}">
                                <i class="fas fa-times-circle"></i> 주문취소
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- 데이터 없을 때 -->
    <div th:if="${orders.isEmpty()}" class="no-data">
        <i class="fas fa-inbox"></i>
        <p>주문 내역이 없습니다.</p>
    </div>
</div>

<!-- 푸터 Include -->
<div th:replace="~{common/footer}"></div>

<script>
// 검색 수행
function performSearch() {
    applyFilters();
}

// 필터 적용
function applyFilters() {
    const orderStatus = document.getElementById('orderStatusSelect').value;
    const search = document.getElementById('searchInput').value;

    let url = '/order/adminlist';
    const params = [];

    if (orderStatus) {
        params.push('orderStatus=' + encodeURIComponent(orderStatus));
    }
    if (search) {
        params.push('search=' + encodeURIComponent(search));
    }

    if (params.length > 0) {
        url += '?' + params.join('&');
    }

    window.location.href = url;
}

// 주문 상세 보기
function viewOrderDetail(orderId) {
    window.location.href = '/order/detail/' + orderId;
}

// 상태 드롭다운 토글
function toggleStatusDropdown(button) {
    const orderId = button.dataset.orderId;
    const selectElement = document.getElementById('status-select-' + orderId);
    const btnElement = document.getElementById('status-btn-' + orderId);

    // 다른 드롭다운들 모두 숨기기
    document.querySelectorAll('.status-dropdown').forEach(select => {
        if (select.id !== 'status-select-' + orderId) {
            select.style.display = 'none';
        }
    });
    document.querySelectorAll('.btn-status').forEach(btn => {
        if (btn.id !== 'status-btn-' + orderId) {
            btn.style.display = '';
        }
    });

    // 현재 버튼과 드롭다운 토글
    if (selectElement.style.display === 'none') {
        selectElement.style.display = '';
        btnElement.style.display = 'none';
        selectElement.focus();
    } else {
        selectElement.style.display = 'none';
        btnElement.style.display = '';
    }
}

// 주문 상태 변경
async function changeOrderStatus(selectElement) {
    const orderId = selectElement.dataset.orderId;
    const newStatus = selectElement.value;

    if (!newStatus || newStatus === '') {
        selectElement.style.display = 'none';
        document.getElementById('status-btn-' + orderId).style.display = '';
        return;
    }

    if (!confirm(`주문 ${orderId}의 상태를 ${getStatusLabel(newStatus)}(으)로 변경하시겠습니까?`)) {
        selectElement.value = '';
        selectElement.style.display = 'none';
        document.getElementById('status-btn-' + orderId).style.display = '';
        return;
    }

    try {
        const response = await fetch(`/api/order/${orderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ orderStatus: newStatus })
        });

        if (response.ok) {
            alert('주문 상태가 변경되었습니다.');
            location.reload();
        } else {
            const error = await response.text();
            alert('상태 변경 실패: ' + error);
            selectElement.value = '';
            selectElement.style.display = 'none';
            document.getElementById('status-btn-' + orderId).style.display = '';
        }
    } catch (error) {
        console.error('상태 변경 중 오류:', error);
        alert('상태 변경 중 오류가 발생했습니다.');
        selectElement.value = '';
        selectElement.style.display = 'none';
        document.getElementById('status-btn-' + orderId).style.display = '';
    }
}

// 주문 취소
async function cancelOrder(orderId) {
    if (!confirm(`주문 ${orderId}를 취소하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/order/${orderId}/cancel`, {
            method: 'PUT'
        });

        if (response.ok) {
            alert('주문이 취소되었습니다.');
            location.reload();
        } else {
            const error = await response.text();
            alert('주문 취소 실패: ' + error);
        }
    } catch (error) {
        console.error('주문 취소 중 오류:', error);
        alert('주문 취소 중 오류가 발생했습니다.');
    }
}

// 상태 레이블 가져오기
function getStatusLabel(status) {
    const labels = {
        'PENDING': '결제대기',
        'COMPLETED': '결제완료',
        'PROCESSING': '배송준비',
        'SHIPPED': '배송중',
        'DELIVERED': '배송완료',
        'RETURN': '반품신청',
        'SWAP': '교환신청',
        'CANCELLED': '주문취소',
        'FAILED': '결제실패'
    };
    return labels[status] || status;
}

// 엔터 키로 검색
document.getElementById('searchInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        performSearch();
    }
});
</script>

</body>
</html>
