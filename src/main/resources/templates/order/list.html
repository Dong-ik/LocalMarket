<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸ ëª©ë¡ - LocalMarket</title>
    <link rel="stylesheet" th:href="@{/css/localmarket.css}">
    <link rel="stylesheet" th:href="@{/css/order-list.css}">
</head>
<body>
    <div th:replace="~{common/header}"></div>

    <div class="order-list-container">
        <h1 class="page-title">ì£¼ë¬¸ ë‚´ì—­</h1>
        
        <div class="order-filter">
            <button class="filter-btn active" onclick="filterOrders('all')">ì „ì²´</button>
            <button class="filter-btn" onclick="filterOrders('PENDING')">ì£¼ë¬¸ì™„ë£Œ</button>
            <button class="filter-btn" onclick="filterOrders('COMPLETED')">ê²°ì œì™„ë£Œ</button>
            <button class="filter-btn" onclick="filterOrders('PROCESSING')">ë°°ì†¡ì¤€ë¹„</button>
            <button class="filter-btn" onclick="filterOrders('SHIPPED')">ë°°ì†¡ì¤‘</button>
            <button class="filter-btn" onclick="filterOrders('DELIVERED')">ë°°ì†¡ì™„ë£Œ</button>
            <button class="filter-btn" onclick="filterOrders('RETURN')">ë°˜í’ˆì‹ ì²­</button>
            <button class="filter-btn" onclick="filterOrders('SWAP')">êµí™˜ì‹ ì²­</button>
        </div>
        
        <div class="order-list" th:if="${orders != null and !orders.isEmpty()}">
            <div class="order-card" th:each="order : ${orders}" th:data-status="${order.orderStatus}">
                <div class="order-header">
                    <div class="order-date" th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm')}"></div>
                    <div class="order-status" th:classappend="${order.orderStatus}">
                        <span th:text="${order.orderStatus == 'PENDING' ? 'ì£¼ë¬¸ì™„ë£Œ' :
                                        order.orderStatus == 'COMPLETED' ? 'ê²°ì œì™„ë£Œ' :
                                        order.orderStatus == 'PROCESSING' ? 'ë°°ì†¡ì¤€ë¹„' :
                                        order.orderStatus == 'SHIPPED' ? 'ë°°ì†¡ì¤‘' :
                                        order.orderStatus == 'DELIVERED' ? 'ë°°ì†¡ì™„ë£Œ' :
                                        order.orderStatus == 'CANCELLED' ? 'ì£¼ë¬¸ì·¨ì†Œ' :
                                        order.orderStatus == 'RETURN' ? 'ë°˜í’ˆì‹ ì²­' :
                                        order.orderStatus == 'SWAP' ? 'êµí™˜ì‹ ì²­' :
                                        order.orderStatus}">ë°°ì†¡ì¤€ë¹„</span>
                    </div>
                </div>
                
                <div class="order-body">
                    <div class="order-products">
                        <div class="product-item" th:each="detail, iterStat : ${order.orderDetails}"
                             th:if="${iterStat.index < 2}">
                            <div class="product-image-list">
                                <img th:if="${detail.productFilename != null}"
                                     th:src="@{'/images/products/' + ${detail.productFilename}}"
                                     th:alt="${detail.productName}"
                                     onerror="this.src='/images/no-image.jpg'">
                                <div th:if="${detail.productFilename == null}" class="no-image">
                                    <i class="fas fa-image"></i>
                                </div>
                            </div>
                            <div class="product-info">
                                <div class="product-name" th:text="${detail.productName}"></div>
                                <div class="product-quantity">
                                    <span th:text="${detail.orderQuantity}"></span>ê°œ /
                                    <span th:text="${#numbers.formatInteger(detail.orderPrice, 0, 'COMMA')}"></span>ì›
                                </div>
                            </div>
                        </div>
                        <div class="more-products" th:if="${order.orderDetails.size() > 2}">
                            ì™¸ <span th:text="${order.orderDetails.size() - 2}"></span>ê°œ ìƒí’ˆ
                        </div>
                    </div>
                    
                    <div class="order-summary">
                        <div class="order-total">
                            ì´ ê²°ì œê¸ˆì•¡: 
                            <strong th:text="${#numbers.formatInteger(order.orderTotalPrice, 0, 'COMMA')} + 'ì›'"></strong>
                        </div>
                        <div class="order-actions">
                            <button th:if="${order.orderStatus == 'DELIVERED'}" class="btn-return" th:data-order-id="${order.orderId}" onclick="updateOrderStatus(this, 'RETURN')">
                                ë°˜í’ˆì‹ ì²­
                            </button>
                            <button th:if="${order.orderStatus == 'DELIVERED'}" class="btn-swap" th:data-order-id="${order.orderId}" onclick="updateOrderStatus(this, 'SWAP')">
                                êµí™˜ì‹ ì²­
                            </button>
                            <button class="btn-detail" th:onclick="'viewOrderDetail(' + ${order.orderId} + ')'">
                                ìƒì„¸ë³´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="empty-state" th:if="${orders == null or orders.isEmpty()}">
            <div class="empty-icon">ğŸ“¦</div>
            <h3>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì§€ê¸ˆ ë°”ë¡œ LocalMarketì—ì„œ ì‡¼í•‘ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
            <button class="btn-shopping" onclick="goToProducts()">
                ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°
            </button>
        </div>
    </div>

    <div th:replace="~{common/footer}"></div>

    <script>
        // ì£¼ë¬¸ ìƒì„¸ ë³´ê¸°
        function viewOrderDetail(orderId) {
            window.location.href = '/order/' + orderId;
        }

        // ìƒí’ˆ ëª©ë¡ìœ¼ë¡œ ì´ë™
        function goToProducts() {
            window.location.href = '/products';
        }

        // ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateOrderStatus(button, newStatus) {
            const orderId = button.getAttribute('data-order-id');
            const statusName = newStatus === 'RETURN' ? 'ë°˜í’ˆ' : 'êµí™˜';
            if (!confirm(orderId + ' ì£¼ë¬¸ì„ ' + statusName + 'ì‹ ì²­ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            fetch('/order/' + orderId + '/status', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ orderStatus: newStatus })
            })
            .then(response => {
                if (response.ok) {
                    alert(statusName + 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } else {
                    alert(statusName + 'ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(statusName + 'ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ì£¼ë¬¸ ìƒíƒœë³„ í•„í„°ë§
        function filterOrders(status) {
            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // ì£¼ë¬¸ ì¹´ë“œ í•„í„°ë§
            const orderCards = document.querySelectorAll('.order-card');
            orderCards.forEach(card => {
                if (status === 'all') {
                    card.style.display = 'block';
                } else {
                    if (card.dataset.status === status) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        }
    </script>
</body>
</html>
