<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 상세 - LocalMarket</title>
    <link rel="stylesheet" th:href="@{/css/localmarket.css}">
    <link rel="stylesheet" th:href="@{/css/order-detail.css}">
</head>
<body>
    <div th:replace="~{common/header}"></div>

    <div class="order-detail-container">
        <div class="detail-header">
            <h1 class="detail-title">주문 상세</h1>
            <div class="order-info-summary">
                <span class="order-number">
                    주문번호: <strong th:text="${order.orderId}"></strong>
                </span>
                <span class="order-date" th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm')}"></span>
            </div>
        </div>

        <div class="detail-content">
            <!-- 주문 상태 -->
            <section class="detail-section status-section">
                <div class="status-track">
                    <div class="status-step"
                         th:classappend="${order.orderStatus == 'PENDING' || order.orderStatus == 'PROCESSING' || order.orderStatus == 'SHIPPED' || order.orderStatus == 'DELIVERED'} ? 'active' : ''">
                        <div class="status-icon">✓</div>
                        <div class="status-label">주문완료</div>
                    </div>
                    <div class="status-line"
                         th:classappend="${order.orderStatus == 'PROCESSING' || order.orderStatus == 'SHIPPED' || order.orderStatus == 'DELIVERED'} ? 'active' : ''"></div>
                    <div class="status-step"
                         th:classappend="${order.orderStatus == 'PROCESSING' || order.orderStatus == 'SHIPPED' || order.orderStatus == 'DELIVERED'} ? 'active' : ''">
                        <div class="status-icon">📦</div>
                        <div class="status-label">배송준비</div>
                    </div>
                    <div class="status-line"
                         th:classappend="${order.orderStatus == 'SHIPPED' || order.orderStatus == 'DELIVERED'} ? 'active' : ''"></div>
                    <div class="status-step"
                         th:classappend="${order.orderStatus == 'SHIPPED' || order.orderStatus == 'DELIVERED'} ? 'active' : ''">
                        <div class="status-icon">🚚</div>
                        <div class="status-label">배송중</div>
                    </div>
                    <div class="status-line"
                         th:classappend="${order.orderStatus == 'DELIVERED'} ? 'active' : ''"></div>
                    <div class="status-step"
                         th:classappend="${order.orderStatus == 'DELIVERED'} ? 'active' : ''">
                        <div class="status-icon">✅</div>
                        <div class="status-label">배송완료</div>
                    </div>
                </div>
                <div class="current-status">
                    현재 상태: <strong th:text="${order.orderStatus == 'PENDING' ? '주문완료' :
                                              order.orderStatus == 'PROCESSING' ? '배송준비' :
                                              order.orderStatus == 'SHIPPED' ? '배송중' :
                                              order.orderStatus == 'DELIVERED' ? '배송완료' :
                                              order.orderStatus == 'CANCELLED' ? '주문취소' :
                                              order.orderStatus}">배송준비</strong>
                </div>
            </section>

            <!-- 주문 상품 정보 -->
            <section class="detail-section">
                <h2 class="section-title">주문 상품</h2>
                <div class="order-products">
                    <div class="product-item" th:each="detail : ${order.cartItems}">
                        <div class="product-image">
                            <img th:if="${detail.productFilename != null}"
                                 th:src="@{'/images/products/' + ${detail.productFilename}}"
                                 th:alt="${detail.productName}">
                            <div th:if="${detail.productFilename == null}" class="no-image">
                                <i class="fas fa-image"></i>
                            </div>
                        </div>
                        <div class="product-info">
                            <div class="product-name" th:text="${detail.productName}"></div>
                            <div class="product-quantity">
                                수량: <span th:text="${detail.orderQuantity}"></span>개
                            </div>
                        </div>
                        <div class="product-price">
                            <span th:text="${#numbers.formatInteger((detail.orderPrice != null ? detail.orderPrice : 0) * (detail.orderQuantity != null ? detail.orderQuantity : 0), 0, 'COMMA')}"></span>원
                        </div>
                    </div>
                </div>
            </section>

            <!-- 배송 정보 -->
            <section class="detail-section">
                <h2 class="section-title">배송 정보</h2>
                <div class="info-table">
                    <div class="info-row">
                        <div class="info-label">연락처</div>
                        <div class="info-value" th:text="${order.deliveryPhone}">010-1234-5678</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">배송 주소</div>
                        <div class="info-value" th:text="${order.deliveryAddress}">
                            서울시 강남구 테헤란로 123
                        </div>
                    </div>
                    <div class="info-row" th:if="${order.requestMessage}">
                        <div class="info-label">배송 요청사항</div>
                        <div class="info-value" th:text="${order.requestMessage}">문 앞에 놓아주세요</div>
                    </div>
                </div>
            </section>

            <!-- 결제 정보 -->
            <section class="detail-section">
                <h2 class="section-title">결제 정보</h2>
                <div class="payment-summary">
                    <div class="payment-row payment-total">
                        <span>총 결제 금액</span>
                        <span class="payment-value total-price" th:text="${#numbers.formatInteger(order.orderTotalPrice != null ? order.orderTotalPrice : 0, 0, 'COMMA')} + '원'">
                        </span>
                    </div>
                    <div class="payment-method">
                        결제 수단: <span th:text="${order.paymentMethod != null ? order.paymentMethod : '신용카드'}">신용카드</span>
                    </div>
                </div>
            </section>

            <!-- 버튼 영역 -->
            <div class="action-buttons">
                <button type="button" class="btn-secondary" onclick="goToOrderList()">
                    주문 목록
                </button>
                <button type="button" class="btn-primary" onclick="goToHome()"
                        th:if="${order.orderStatus == 'DELIVERED'}">
                    쇼핑 계속하기
                </button>
                <button type="button" class="btn-danger" onclick="cancelOrder()"
                        th:if="${order.orderStatus == 'PENDING'}">
                    주문 취소
                </button>
            </div>
        </div>
    </div>

    <div th:replace="~{common/footer}"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const orderId = /*[[${order.orderId}]]*/ 0;
        const orderStatus = /*[[${order.orderStatus}]]*/ '';
        
        // 주문 목록으로 이동
        function goToOrderList() {
            window.location.href = '/order/list';
        }
        
        // 홈으로 이동
        function goToHome() {
            window.location.href = '/';
        }
        
        // 주문 취소
        async function cancelOrder() {
            if (!confirm('정말 주문을 취소하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/order/${orderId}/cancel`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    alert('주문이 취소되었습니다.');
                    location.reload();
                } else {
                    const error = await response.text();
                    alert('주문 취소 실패: ' + error);
                }
            } catch (error) {
                console.error('주문 취소 중 오류:', error);
                alert('주문 취소 중 오류가 발생했습니다.');
            }
        }
        /*]]>*/
    </script>
</body>
</html>
