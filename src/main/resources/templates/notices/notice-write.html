<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공지사항 작성 - LocalMarket</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 헤더 Include -->
    <div th:replace="~{common/header}"></div>
    
    <!-- Notice CSS를 header 이후에 로드하여 우선순위 확보 -->
    <link rel="stylesheet" th:href="@{/css/notice.css}">

    <!-- 공지사항 작성 컨테이너 -->
    <div class="notice-write-container">
        <div class="write-card">
            <h1 class="write-title">
                <i class="fas fa-pen"></i> 공지사항 작성
            </h1>

            <form id="noticeForm" class="notice-form">
                <!-- 제목 입력 -->
                <div class="form-group">
                    <label for="noticeTitle" class="form-label">
                        제목 <span class="required">*</span>
                    </label>
                    <input type="text" id="noticeTitle" class="form-input" 
                           placeholder="공지사항 제목을 입력하세요 (최대 100자)" 
                           maxlength="100" required>
                    <div class="char-count">
                        <span id="titleCount">0</span> / 100
                    </div>
                </div>

                <!-- 내용 입력 -->
                <div class="form-group">
                    <label for="noticeContent" class="form-label">
                        내용 <span class="required">*</span>
                    </label>
                    <textarea id="noticeContent" class="form-textarea" 
                              placeholder="공지사항 내용을 입력하세요 (최대 2000자)" 
                              rows="15" maxlength="2000" required></textarea>
                    <div class="char-count">
                        <span id="contentCount">0</span> / 2000
                    </div>
                </div>

                <!-- 버튼 그룹 -->
                <div class="form-actions">
                    <button type="button" onclick="history.back()" class="btn-cancel">
                        <i class="fas fa-times"></i> 취소
                    </button>
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-check"></i> 등록
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 푸터 Include -->
    <div th:replace="~{common/footer}"></div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const memberNum = /*[[${memberNum}]]*/ null;
        /*]]>*/
        
        // 로그인 체크
        if (!memberNum) {
            alert('로그인이 필요합니다.');
            window.location.href = '/members/login?redirect=/notices/write';
        }
        
        // 글자 수 카운터
        const titleInput = document.getElementById('noticeTitle');
        const contentInput = document.getElementById('noticeContent');
        const titleCount = document.getElementById('titleCount');
        const contentCount = document.getElementById('contentCount');
        
        titleInput.addEventListener('input', function() {
            titleCount.textContent = this.value.length;
        });
        
        contentInput.addEventListener('input', function() {
            contentCount.textContent = this.value.length;
        });
        
        // 폼 제출
        document.getElementById('noticeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();
            
            // 유효성 검사
            if (!title) {
                alert('제목을 입력해주세요.');
                titleInput.focus();
                return;
            }
            
            if (!content) {
                alert('내용을 입력해주세요.');
                contentInput.focus();
                return;
            }
            
            if (!memberNum) {
                alert('로그인이 필요합니다.');
                return;
            }
            
            // 공지사항 등록 API 호출
            const noticeData = {
                noticeTitle: title,
                noticeContent: content,
                memberNum: memberNum
            };
            
            fetch('/api/notices', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(noticeData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('공지사항이 등록되었습니다.');
                    window.location.href = '/notices';
                } else {
                    alert('등록 실패: ' + (data.message || '알 수 없는 오류'));
                }
            })
            .catch(error => {
                console.error('등록 중 오류:', error);
                alert('등록 중 오류가 발생했습니다.');
            });
        });
    </script>
</body>
</html>
