<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시장 목록 - LocalMarket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
</head>
<body>
    <!-- 헤더 영역 -->
    <div th:replace="~{layout :: header}"></div>

    <!-- 메인 콘텐츠 -->
    <div class="container mt-4">
        <!-- 페이지 제목 및 검색 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h2 class="mb-0">
                    <i class="fas fa-store text-primary me-2"></i>
                    시장 목록
                </h2>
                <p class="text-muted mt-2">시장 정보를 한번에 확인하세요</p>
            </div>
            <div class="col-md-3">
                <form th:action="@{/markets/list}" method="get" class="d-flex">
                    <input type="text" class="form-control me-2" name="search" 
                           th:value="${searchTerm}" placeholder="시장명으로 검색">
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>
            <div class="col-md-3 text-end">
                <a href="/markets/import" class="btn btn-success">
                    <i class="fas fa-download me-2"></i>전통시장 데이터 가져오기
                </a>
            </div>
        </div>

        <!-- 필터 옵션 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-3">
                        <form th:action="@{/markets/list}" method="get" class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label for="location" class="form-label">지역 선택</label>
                                <select class="form-select" id="location" name="location">
                                    <option value="">전체 지역</option>
                                    <option value="서울" th:selected="${selectedLocation == '서울'}">서울</option>
                                    <option value="부산" th:selected="${selectedLocation == '부산'}">부산</option>
                                    <option value="대구" th:selected="${selectedLocation == '대구'}">대구</option>
                                    <option value="인천" th:selected="${selectedLocation == '인천'}">인천</option>
                                    <option value="광주" th:selected="${selectedLocation == '광주'}">광주</option>
                                    <option value="대전" th:selected="${selectedLocation == '대전'}">대전</option>
                                    <option value="울산" th:selected="${selectedLocation == '울산'}">울산</option>
                                    <option value="세종" th:selected="${selectedLocation == '세종'}">세종</option>
                                    <option value="경기" th:selected="${selectedLocation == '경기'}">경기</option>
                                    <option value="강원" th:selected="${selectedLocation == '강원'}">강원</option>
                                    <option value="충북" th:selected="${selectedLocation == '충북'}">충북</option>
                                    <option value="충남" th:selected="${selectedLocation == '충남'}">충남</option>
                                    <option value="전북" th:selected="${selectedLocation == '전북'}">전북</option>
                                    <option value="전남" th:selected="${selectedLocation == '전남'}">전남</option>
                                    <option value="경북" th:selected="${selectedLocation == '경북'}">경북</option>
                                    <option value="경남" th:selected="${selectedLocation == '경남'}">경남</option>
                                    <option value="제주" th:selected="${selectedLocation == '제주'}">제주</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="search" class="form-label">시장명 검색</label>
                                <input type="text" class="form-control" id="search" name="search" 
                                       th:value="${searchTerm}" placeholder="시장명을 입력하세요">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-filter me-2"></i>검색
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 검색 결과 정보 -->
        <div class="row mb-3" th:if="${searchTerm != null or selectedLocation != null}">
            <div class="col-12">
                <div class="alert alert-info border-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <span th:if="${searchTerm != null and selectedLocation != null}">
                        '<strong th:text="${searchTerm}"></strong>' 검색 결과 (<strong th:text="${selectedLocation}"></strong> 지역)
                    </span>
                    <span th:if="${searchTerm != null and selectedLocation == null}">
                        '<strong th:text="${searchTerm}"></strong>' 검색 결과
                    </span>
                    <span th:if="${searchTerm == null and selectedLocation != null}">
                        <strong th:text="${selectedLocation}"></strong> 지역 시장
                    </span>
                    - 일반시장 <strong th:text="${#lists.size(markets)}"></strong>개
                    <span th:if="${traditionalMarkets != null}">
                        / 전통시장 <strong th:text="${#lists.size(traditionalMarkets)}"></strong>개
                    </span>
                </div>
            </div>
        </div>

        <!-- 통합 시장 목록 -->
        <div class="row" th:if="${(markets != null and !markets.isEmpty()) or (traditionalMarkets != null and !traditionalMarkets.isEmpty())}">
            <!-- 일반시장 카드들 (DB 기본정보 + API 편의시설 정보 조합) -->
            <div class="col-lg-4 col-md-6 mb-4" th:each="market : ${markets}">
                <div class="card h-100 shadow-sm border-0 unified-market-card">
                    <!-- 시장 이미지 (DB에서) -->
                    <div class="position-relative">
                        <img th:if="${market.marketFilename != null and !market.marketFilename.isEmpty()}" 
                             th:src="@{'/images/markets/' + ${market.marketFilename}}" 
                             class="card-img-top market-image" 
                             th:alt="${market.marketName}"
                             style="height: 200px; object-fit: cover;">
                        <img th:if="${market.marketFilename == null or market.marketFilename.isEmpty()}" 
                             src="/images/default-market.jpg" 
                             class="card-img-top market-image" 
                             th:alt="${market.marketName}"
                             style="height: 200px; object-fit: cover;">
                        <!-- 지역 뱃지 (DB에서) -->
                        <span class="badge bg-primary position-absolute top-0 end-0 m-2" 
                              th:text="${market.marketLocal}"></span>
                        <!-- 시장 타입 표시 -->
                        <span class="badge bg-info position-absolute top-0 start-0 m-2">
                            <i class="fas fa-store me-1"></i>일반시장
                        </span>
                    </div>
                    
                    <div class="card-body">
                        <!-- 시장명 (DB에서) -->
                        <h5 class="card-title text-truncate" th:text="${market.marketName}"></h5>
                        <!-- 시장주소 (DB에서) -->
                        <p class="card-text text-muted small">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            <span th:text="${market.marketAddress ?: '주소 정보 없음'}"></span>
                        </p>
                        
                        <!-- 시장 소개 (DB에서) -->
                        <p class="card-text" th:if="${market.marketIntroduce != null and !market.marketIntroduce.isEmpty()}">
                            <span th:text="${#strings.length(market.marketIntroduce) > 100 ? 
                                          #strings.substring(market.marketIntroduce, 0, 100) + '...' : 
                                          market.marketIntroduce}"></span>
                        </p>
                        
                        <!-- 편의시설 정보 (API에서 - 해당 시장과 매칭되는 전통시장 데이터가 있는 경우) -->
                        <div th:with="matchingTraditional=${traditionalMarkets != null ? 
                            #lists.toList(traditionalMarkets).stream()
                                .filter(t -> t.marketName.contains(market.marketName) or market.marketName.contains(t.marketName))
                                .findFirst().orElse(null) : null}">
                            
                            <div class="mb-3" th:if="${matchingTraditional != null and matchingTraditional.facilitiesAsString != null and !matchingTraditional.facilitiesAsString.isEmpty()}">
                                <h6 class="text-success mb-2">
                                    <i class="fas fa-wheelchair me-1"></i>편의시설 <small class="text-muted">(API)</small>
                                </h6>
                                <div class="facility-tags">
                                    <span th:each="facility : ${#strings.listSplit(matchingTraditional.facilitiesAsString, ', ')}" 
                                          class="badge bg-light text-dark me-1 mb-1" 
                                          th:text="${facility}"></span>
                                </div>
                            </div>
                            
                            <div class="mb-3" th:if="${matchingTraditional == null or matchingTraditional.facilitiesAsString == null or matchingTraditional.facilitiesAsString.isEmpty()}">
                                <h6 class="text-muted mb-2">
                                    <i class="fas fa-exclamation-circle me-1"></i>편의시설
                                </h6>
                                <small class="text-muted">편의시설 정보 없음</small>
                            </div>
                            
                            <!-- 통계 정보 -->
                            <div class="row text-center small">
                                <div class="col-6">
                                    <div class="border-end">
                                        <span class="store-count" th:data-market-id="${market.marketId}">
                                            <strong class="text-primary">로딩중</strong>
                                            <div class="text-muted">가게 수</div>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <strong class="text-success" th:text="${matchingTraditional != null ? matchingTraditional.facilityCount : 0}">0</strong>
                                    <div class="text-muted">편의시설 수</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-transparent border-top-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <span class="badge bg-secondary">DB+API</span>
                            </small>
                            <div class="btn-group" role="group">
                                <!-- 상세보기 (DB 우선, API 보완) -->
                                <a th:href="@{/markets/detail/{id}(id=${market.marketId})}" 
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>상세보기
                                </a>
                                <!-- 홈페이지 (DB 우선, API 보완) -->
                                <a th:with="matchingTraditional=${traditionalMarkets != null ? 
                                    #lists.toList(traditionalMarkets).stream()
                                        .filter(t -> t.marketName.contains(market.marketName) or market.marketName.contains(t.marketName))
                                        .findFirst().orElse(null) : null}"
                                   th:if="${market.marketUrl != null and !market.marketUrl.isEmpty()}"
                                   th:href="${market.marketUrl}" 
                                   target="_blank"
                                   class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-external-link-alt me-1"></i>홈페이지
                                </a>
                                <a th:with="matchingTraditional=${traditionalMarkets != null ? 
                                    #lists.toList(traditionalMarkets).stream()
                                        .filter(t -> t.marketName.contains(market.marketName) or market.marketName.contains(t.marketName))
                                        .findFirst().orElse(null) : null}"
                                   th:if="${(market.marketUrl == null or market.marketUrl.isEmpty()) and matchingTraditional != null and matchingTraditional.website != null and !matchingTraditional.website.isEmpty()}"
                                   th:href="${matchingTraditional.website}" 
                                   target="_blank"
                                   class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-external-link-alt me-1"></i>홈페이지 <small>(API)</small>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 전통시장 전용 카드들 (일반시장과 매칭되지 않는 전통시장들) -->
            <div class="col-lg-4 col-md-6 mb-4" th:each="traditional : ${traditionalMarkets}"
                 th:with="hasMatching=${markets != null and #lists.toList(markets).stream()
                    .anyMatch(m -> m.marketName.contains(traditional.marketName) or traditional.marketName.contains(m.marketName))}"
                 th:if="${not hasMatching}">
                <div class="card h-100 shadow-sm border-0 traditional-only-card">
                    <!-- 전통시장 헤더 -->
                    <div class="card-header bg-success text-white p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <small>
                                <i class="fas fa-landmark me-1"></i>전통시장
                            </small>
                            <span class="badge bg-light text-dark" th:text="${traditional.siDoName}">지역</span>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <h5 class="card-title text-truncate" th:text="${traditional.marketName}"></h5>
                        <p class="card-text text-muted small">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            <span th:text="${traditional.roadAddress ?: traditional.detailAddress ?: '주소 정보 없음'}"></span>
                        </p>
                        
                        <!-- 편의시설 정보 -->
                        <div class="mb-3" th:if="${traditional.facilitiesAsString != null and !traditional.facilitiesAsString.isEmpty()}">
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-wheelchair me-1"></i>편의시설
                            </h6>
                            <div class="facility-tags">
                                <span th:each="facility : ${#strings.listSplit(traditional.facilitiesAsString, ', ')}" 
                                      class="badge bg-light text-dark me-1 mb-1" 
                                      th:text="${facility}"></span>
                            </div>
                        </div>
                        <div class="mb-3" th:if="${traditional.facilitiesAsString == null or traditional.facilitiesAsString.isEmpty()}">
                            <h6 class="text-muted mb-2">
                                <i class="fas fa-exclamation-circle me-1"></i>편의시설
                            </h6>
                            <small class="text-muted">편의시설 정보 없음</small>
                        </div>
                        
                        <div class="row text-center small">
                            <div class="col-6">
                                <div class="border-end">
                                    <strong class="text-primary" th:text="${traditional.storeCount ?: 0}">0</strong>
                                    <div class="text-muted">점포수</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <strong class="text-success" th:text="${traditional.facilityCount ?: 0}">0</strong>
                                <div class="text-muted">편의시설 수</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-top-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <span class="badge bg-success">API 전용</span>
                            </small>
                            <div class="btn-group" role="group">
                                <a th:if="${traditional.website != null and !traditional.website.isEmpty()}"
                                   th:href="${traditional.website}" 
                                   target="_blank"
                                   class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-external-link-alt me-1"></i>홈페이지
                                </a>
                                <span th:if="${traditional.website == null or traditional.website.isEmpty()}"
                                      class="text-muted small">홈페이지 없음</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 데이터 출처 정보 (통합) -->
        <div class="row mt-4" th:if="${(markets != null and !markets.isEmpty()) or (traditionalMarkets != null and !traditionalMarkets.isEmpty())}">
            <div class="col-12">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="fas fa-info-circle text-info me-2"></i>데이터 출처
                        </h6>
                        <div class="row">
                            <div class="col-md-6" th:if="${markets != null and !markets.isEmpty()}">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-database text-secondary me-2"></i>
                                    <div>
                                        <strong>일반시장:</strong> LocalMarket 자체 데이터베이스
                                        <br>
                                        <small class="text-muted">내부 관리 데이터 | 실시간 업데이트</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6" th:if="${traditionalMarkets != null and !traditionalMarkets.isEmpty()}">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-landmark text-success me-2"></i>
                                    <div>
                                        <strong>전통시장:</strong> 
                                        <a href="https://www.data.go.kr/data/15012892/openapi.do" target="_blank" class="text-decoration-none">
                                            공공데이터포털 API
                                        </a>
                                        <br>
                                        <small class="text-muted">소상공인시장진흥공단 | 2024년 기준</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 검색 결과 없음 -->
        <div class="row" th:if="${(markets == null or markets.isEmpty()) and (traditionalMarkets == null or traditionalMarkets.isEmpty())}">
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">검색 결과가 없습니다</h4>
                    <p class="text-muted">다른 검색어로 다시 시도해보세요.</p>
                    <a href="/markets/list" class="btn btn-primary">
                        <i class="fas fa-list me-2"></i>전체 시장 보기
                    </a>
                </div>
            </div>
        </div>

        <!-- 페이지네이션 (필요시 추가) -->
        <div class="row mt-5" th:if="${markets != null and markets.size() > 12}">
            <div class="col-12">
                <nav aria-label="시장 목록 페이지네이션">
                    <ul class="pagination justify-content-center">
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="이전">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="다음">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- 푸터 영역 -->
    <div th:replace="~{layout :: footer}"></div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 각 시장의 가게 수를 AJAX로 로딩
        document.addEventListener('DOMContentLoaded', function() {
            const storeCountElements = document.querySelectorAll('.store-count');
            
            storeCountElements.forEach(function(element) {
                const marketId = element.getAttribute('data-market-id');
                
                fetch(`/api/markets/${marketId}/stores/count`)
                    .then(response => response.json())
                    .then(count => {
                        element.textContent = `가게 ${count}개`;
                    })
                    .catch(error => {
                        console.error('가게 수 로딩 실패:', error);
                        element.textContent = '가게 수 조회 실패';
                    });
            });
        });
        
        // 카드 호버 효과
        document.querySelectorAll('.unified-market-card, .traditional-only-card, .market-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.transition = 'transform 0.3s ease';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    </script>

    <style>
        .market-card, .traditional-market-card, .unified-market-card, .traditional-only-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .market-card:hover, .traditional-market-card:hover, .unified-market-card:hover, .traditional-only-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
            transform: translateY(-5px);
        }
        
        .market-image {
            transition: transform 0.3s ease;
        }
        
        .unified-market-card:hover .market-image, .market-card:hover .market-image {
            transform: scale(1.05);
        }
        
        .traditional-market-card, .traditional-only-card {
            border-left: 4px solid #28a745;
        }
        
        .traditional-market-card:hover, .traditional-only-card:hover {
            border-left-color: #1e7e34;
        }
        
        .unified-market-card {
            border-left: 4px solid #17a2b8;
        }
        
        .unified-market-card:hover {
            border-left-color: #138496;
        }
        
        .card-footer .btn-group .btn {
            border-radius: 0.375rem;
        }
        
        .facility-tags .badge {
            font-size: 0.75em;
            border: 1px solid #dee2e6;
        }
        
        .facility-tags .badge:hover {
            background-color: #e9ecef !important;
            border-color: #adb5bd;
        }
    </style>
</body>
</html>